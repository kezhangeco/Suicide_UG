---
title: "UG_data_analysis1"
author: "Ke"
date: '2018-01-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
library(lme4)
library(ggplot2)
library(GGally)
library(plyr)
library(Matrix)
library(readxl)
library(reshape2)
library(numDeriv)
library(MuMIn)
library(glmulti)
library(rJava)
library(mice)
library(stargazer)
library(margins)
```


```{r data, echo=FALSE}
# import data
#task <- read.csv("/home/kzhang5/scratch/ug_all_task_data.csv")
#demo <- read_excel("/home/kzhang5/scratch/ug_demog.xlsx")
#question <- read_excel("/home/kzhang5/scratch/ug_questionnaire.xlsx")
#
#task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
#demo <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_demog.xlsx")
#question <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_questionnaire.xlsx")


task <- read.csv("~/code/Suicide_UG/ug_all_task_data.csv")
demo <- read_excel("~/code/Suicide_UG/ug_demog.xlsx")
question <- read_excel("~/code/Suicide_UG/ug_questionnaire.xlsx")

question <- rename(question, c("UPPSP NEG URGENCY" = "urgency"))
demoQuestion <- merge(demo, question, on = "ID")
allData <- merge(task, demoQuestion, on = "ID")
allData$totalStake <- allData$PlayerProposedAmount + allData$OpponentProposedAmount
allData <- rename(allData, c("HOUSEHOLD INCOME" = "HouseholdIncome", "HRSD NO SUI" = "HRSD_NO_SUI", "PER CAPITA INCOME" = "IncomePerCapita", "MMSE TOTAL" = "MMSE"))
allData$Fairness_score <- as.factor(allData$Fairness_score)
allData$ID <- as.factor(allData$ID)
allData$AcceptOffer <- as.factor(allData$AcceptOffer)

# reference group = control
allData <- within(allData, group4 <- relevel(group4, ref = "control"))
allData <- within(allData, group5 <- relevel(group5, ref = "control"))

# block number
allData$block <- NA
allData$block <- ifelse(allData$merged_trial < 27, "1", ifelse((allData$merged_trial > 26) & (allData$merged_trial < 53), "2", "3" ))
```

variables in the models:
 - Reappraisal Direction
 - total stake
 - Fairness score
 - clinical groups
 - education
 - IncomePerCapita
 - EXIT (4 missing values)
 - trial number (within block number)
 - block number
 - an impulsivity measure: BIS_NONPLAN (3 missing values)/UPPS negative urgency
 - an interpersonal function measure: IIP15INTAMBV (4 missing values)

```{r missing values, include=FALSE}
# complete missing values
# check how many percentage of data is missing in the question dataframe
pMiss <- function(x){sum(is.na(x))/length(x)*100}
missingVar <- c('ID', 'BIS_NONPLAN', 'IIP15INTAMBV', 'EXIT', 'urgency')
missingDF <- question[, missingVar]
apply(question[missingVar], 2, pMiss)
print(md.pattern(question[missingVar]))

# impute data
missingDF_impute <- mice(missingDF, m = 5, meth = "pmm", maxit = 50)
missingVar_complete <- complete(missingDF_impute, 1)

# rename the columns with missing values in the original dataframe
allData <- rename(allData, c("BIS_NONPLAN" = "BIS_NONPLAN_miss", "IIP15INTAMBV" = "IIP15INTAMBV_miss", "EXIT" = "EXIT_miss", "urgency" = "urgency_miss"))

# merge the generated values to the df
allData <- merge(allData, missingVar_complete, by = "ID")
which(is.na(allData$EXIT))
```

```{r wrapper, include=FALSE}
glmer.glmulti <- function(formula, data, random = ""){
  glmer(paste(deparse(formula), random), data = data, family = binomial, control = glmerControl(calc.derivs = FALSE))
}

# covert logits to odds and probability for interpretation
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

logit2OR <- function(logit){
  odds <- exp(logit)
  return(odds)
}
```


# Whether HLM is needed?
## Intercept only
$$Accept\,Offer = 1$$
```{r}
interceptOnly <- glm(task$AcceptOffer ~ 1, family = binomial, data = task)
p_interceptOnly = logit2prob(coef(interceptOnly))

print("logit")
stargazer(interceptOnly, type = "text")
print("probability")
stargazer(p_interceptOnly, type = "text")
```

## Null model: random intercept only
$$Accept\,Offer = 1 + (1|ID)$$
```{r}
randomInterceptOnly <- glmer(task$AcceptOffer ~ 1 + (1|id), data = task, family = binomial)
p_randomInterceptOnly = logit2prob(summary(randomInterceptOnly)$coefficients)

print("logit coefficients")
stargazer(randomInterceptOnly, type = "text")

cf <- data.frame(summary(randomInterceptOnly)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
By adding the ID (nested), the AIC (1|D) is smaller than the AIC (1). So HLM is necessary. 

The variance of the intercept in the *null model is 1.157*. That is the variance can't be explained by the random effect of ID. Compare the variance with more complicated models. If the intercept variance gets smaller, that is an indication of the additional predictors adding more explanation to the DV.

##  Intraclass Correlation (ICC)
Test if HLM is needed: whether there is variation over the level 2 variable (participant ID). If the ICC > 0, then HLM is needed.
```{r ICC, echo=FALSE}
ICC_model <- function(modelName) {
  tau_null <- as.numeric(lapply(summary(modelName)$varcor, diag))
  sigma_null <- as.numeric(attr(summary(modelName)$varcor, "sc")^2)
  ICC_null <- tau_null/(tau_null + sigma_null)
  return(ICC_null)
}

cat("ICC is", ICC_model(randomInterceptOnly))
```
The ICC > 0, the HLM is needed.

# correlation matrix of the subject level variables
```{r corrMatrix, echo=FALSE}
ggpairs(demoQuestion[, c("PER CAPITA INCOME", "HRSD NO SUI", "EDUCATION", "EXIT", "BIS_NONPLAN", "IIP15INTAMBV", "urgency")])
```
The following variables are moderately/highly correlated:
DRS x income, **education x income**, **EXIT x education**, **BIS nonplan x income**, BIS nonplan x HSD, **interpersonal x BIS nonplan**, urgency x HSD, urgency x BIS nonplan, **urgency x interpersonal**.

# Level 1 model (Random intercept and fixed slopes with random effect (1|ID))
## No interaction model

$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + (1|ID)$$
```{r level1Var}
m0 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + (1|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

print("logit coefficients")
stargazer(m0, type = "text")

cf <- data.frame(summary(m0)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

# avg marginal effects
m <- marginal_effects(summary(m0)$coefficients)
summary(m)
plot(m)
```

# Level 1 model with $group$ predictor (random effect (1|ID))
## No interaction effect
The model with 4 groups and 5 groups:
$$Accept\,Offer = Reappraisal\,Direction + totalStake + Fairness\,score + group4 + (1|ID)$$
```{r level1Var&Group, echo=FALSE}
m3 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + (1|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

m3_1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group5 + (1|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

print("model with 4 groups")
stargazer(m3, type = "text")

cf <- data.frame(summary(m3)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

print("model with 5 groups")
stargazer(m3_1, type = "text")

cf1 <- data.frame(summary(m3_1)$coefficients[, 1])
colnames(cf1) <- c("probability")
print("probability coefficients")
print(logit2prob(cf1))

```
Clinically groups are not significantly different from HC in terms of gamble acceptance.

### The model with an individual subject level variable
$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + group4 + VAR + (1|ID)$$
```{r level1Var&Demo, echo=FALSE}
m_education <- update(m3, .~. + scale(EDUCATION))
m_income <- update(m3, .~. + scale(IncomePerCapita))
m_exit <- update(m3, .~. + scale(EXIT))
m_mmse <- update(m3, .~. + scale(MMSE))
m_nonplan <- update(m3, .~. + scale(BIS_NONPLAN))
m_urgency <- update(m3, .~. + scale(urgency))
m_interpersonal <- update(m3, .~. + scale(IIP15INTAMBV))

print("EXIT")
stargazer(m_exit, type = "text")
cf3 <- data.frame(summary(m_exit)$coefficients[, 1])
colnames(cf3) <- c("probability")
print("probability coefficients")
print(logit2prob(cf3))

print("Education")
stargazer(m_education, type = "text")
cf1 <- data.frame(summary(m_education)$coefficients[, 1])
colnames(cf1) <- c("probability")
print("probability coefficients")
print(logit2prob(cf1))


print("income")
stargazer(m_income, type = "text")
cf2 <- data.frame(summary(m_income)$coefficients[, 1])
colnames(cf2) <- c("probability")
print("probability coefficients")
print(logit2prob(cf2))


print("MMSE")
stargazer(m_mmse, type = "text")
cf4 <- data.frame(summary(m_mmse)$coefficients[, 1])
colnames(cf4) <- c("probability")
print("probability coefficients")
print(logit2prob(cf4))


print("UPPSP NEG URGENCY")
stargazer(m_urgency, type = "text")
cf5 <- data.frame(summary(m_urgency)$coefficients[, 1])
colnames(cf5) <- c("probability")
print("probability coefficients")
print(logit2prob(cf5))


print("IIP15INTAMBV, interpersonal")
stargazer(m_interpersonal, type = "text")
cf6 <- data.frame(summary(m_interpersonal)$coefficients[, 1])
colnames(cf6) <- c("probability")
print("probability coefficients")
print(logit2prob(cf6))


print("nonplan")
stargazer(m_nonplan, type = "text")
cf7 <- data.frame(summary(m_nonplan)$coefficients[, 1])
colnames(cf7) <- c("probability")
print("probability coefficients")
print(logit2prob(cf7))


```
$EXIT$ is the only subject level variable has significant influence on the gamble acceptance. Controlling $EXIT$, depression group is more likely to accept gamble compared to the HC.

## Interaction effect models
Fit specific interaction models. From higher order to lower.

$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + group4 + INTERACTION + (1|ID)$$

1.  $Reappraisal\,Direction$ x $scale(total\,Stake)$ x $Fairness\,score$ x $group4$ four way interaction effect, and see if the model is significant. If not, drop this interaction.

```{r 4way interaction, include = FALSE}
m2_4interaction <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + ReappraisalDirection * scale(totalStake) * Fairness_score * group4 + (1|ID), data = allData, family = binomial, glmerControl(calc.derivs = FALSE, optCtrl = list(maxfun = 2e4)))

stargazer(m2_4interaction, type = "text")
cf <- data.frame(summary(m2_4interaction)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
It failed to converge at 4 way interaction

2. $ReappraisalDirection$ x $Fairness_score$ x $group4$ three way interaction
```{r 3way interaction, include = FALSE}
m2_3interaction1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + ReappraisalDirection * Fairness_score * group4 + (1|ID), data = allData, family = binomial, control = glmerControl(calc.derivs = FALSE, optCtrl = list(maxfun = 2e4)))

stargazer(m2_3interaction1, type = "text")
```
It failed to converge.

3. $Reappraisal\,Direction$ x $scale(total\,Stake)$ x $group4$ three way interaction
```{r pairwise, echo=FALSE}
m2_3interaction2 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + ReappraisalDirection * scale(totalStake) * group4 + (1|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))

stargazer(m2_3interaction2, type = "text")

cf <- data.frame(summary(m2_3interaction2)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
$Reappraisal\,Direction$ x $scale(total\,Stake)$ x $group4$ has weak significant influence on gamble acceptance. $Reappraisal\,Directionempathy$ x $scale(total\,Stake)$ x $group4attempter$ is more likely to accept gamble.

4. $fairness\, score$ x $group4$ two way interaction
```{r, echo=FALSE}
m2_2interaction1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score * group4 + (1|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))
stargazer(m2_2interaction1, type = "text")
cf <- data.frame(summary(m2_2interaction1)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

print(logit2OR(cf))

```
Fairness score and group has significant interaction. The depression group is more likely to accept gambles as the unfairness increases, compared to the HC. The attempter is less likely to accept gambles as the unfairness increases.

5. $reappraisal\, direction$ x $group4$ two way interaction
```{r, echo=FALSE}
m2_2interaction2 <- glmer(allData$AcceptOffer ~ scale(totalStake) + Fairness_score + ReappraisalDirection * group4 + (1|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))
stargazer(m2_2interaction2, type = "text")
cf <- data.frame(summary(m2_2interaction2)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))
print(logit2OR(cf))

```
reappraisal direction x group4 has significant interaction. The attempter is less likely to accept the gambles in both empathy and punish context than HC. The depression is more likely to accept the gambles in both empathy and punish context.

6. $total\, stake$ x $group4$ two way interaction
```{r, echo=FALSE}
m2_2interaction4 <- glmer(allData$AcceptOffer ~ scale(totalStake) + ReappraisalDirection + Fairness_score + group4 + scale(totalStake) * group4 + (1|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))
stargazer(m2_2interaction4, type = "text")
cf <- data.frame(summary(m2_2interaction4)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
total stake x group4 has significant interaction. The attempter is less likely to accept the gambles as the stake size increases compared to HC, the depression group is more likely.

7. $total\, stake$ x $fairness\, score$ two way interaction
```{r, echo=FALSE}
m2_2interaction5 <- glmer(allData$AcceptOffer ~ scale(totalStake) + ReappraisalDirection + Fairness_score + group4 + scale(totalStake) * Fairness_score + (1|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))
stargazer(m2_2interaction5, type = "text")
cf <- data.frame(summary(m2_2interaction5)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
total stake x fairness score has significant interaction. The participants are more likely to accept the gambles as the total stake size increases, event the unfairness increase as well.

**Select the best model among the interaction models:**
```{r best interaction model, echo=FALSE}
modellist1 <- model.sel(m2_3interaction2, m2_2interaction1, m2_2interaction2, m2_2interaction3, m2_2interaction4, m2_2interaction5)
print(modellist1)

anova(m2_3interaction2, m2_2interaction2)
```
The 3 way interaction is no significantly better than the 2 way interaction. Hence, The best interaction model is $Reappraisal\,Direction$ x $scale(total\,Stake) x group4$:

```{r, echo=FALSE}
stargazer(m2_3interaction2, type = "text")
cf <- data.frame(summary(m2_3interaction2)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))
```

**the (best) interaction model with the subject level variable**
$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + group4 + \\Reappraisal\,Direction * scale(total\,Stake) * group4 + VAR+ (1|ID)$$
```{r best interaction model and demo var, echo=FALSE}
m_education1 <- update(m2_3interaction2, .~. + scale(EDUCATION))
m_income1 <- update(m2_3interaction2, .~. + scale(IncomePerCapita))
m_exit1 <- update(m2_3interaction2, .~. + scale(EXIT))
m_mmse1 <- update(m2_3interaction2, .~. + scale(MMSE))
m_nonplan1 <- update(m2_3interaction2, .~. + scale(BIS_NONPLAN))
m_urgency1 <- update(m2_3interaction2, .~. + scale(urgency))
m_interpersonal1 <- update(m2_3interaction2, .~. + scale(IIP15INTAMBV))

print("EXIT is the only significant var.")
stargazer(m_exit1, type = "text")
cf <- data.frame(summary(m_exit1)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```

Only $EXIT$, among all the subject level variable has significant influence in the gamble acceptance. The depression group accept more gambles as the stake size increases, regardless of the context.

**2 way interaction model $reappraisal\, direction$ x $group4$ with subject level vars:**
```{r, echo=FALSE}
m_education4 <- update(m2_2interaction2, .~. + scale(EDUCATION))
m_income4 <- update(m2_2interaction2, .~. + scale(IncomePerCapita))
m_exit4 <- update(m2_2interaction2, .~. + scale(EXIT))
m_mmse4 <- update(m2_2interaction2, .~. + scale(MMSE))
m_nonplan4 <- update(m2_2interaction2, .~. + scale(BIS_NONPLAN))
m_urgency4 <- update(m2_2interaction2, .~. + scale(urgency))
m_interpersonal4 <- update(m2_2interaction2, .~. + scale(IIP15INTAMBV))


print("EXIT is the only significant var.")
stargazer(m_exit4, type = "text")
cf <- data.frame(summary(m_exit4)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
The following variable has significant influence in this interaction model:
$EXIT$.

The following codes is for the random effect (block|ID), they are using the same procedure with above model with random effect (1|ID).

# Level 1 model (Random intercept and random slopes with random effect (block|ID))
## No interaction model

$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + (block|ID)$$
```{r level1Var, echo=FALSE}
m5 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + (block|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

stargazer(m5, type = "text")
cf <- data.frame(summary(m5)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```

# Level 1 model with $group$ predictor (random effect (block|ID))
## No interaction effect
With 4 clinical groups and 5 groups.
```{r level1Var & Group, echo=FALSE}
m7 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + (block|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

m7_1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group5 + (block|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

print("model with 4 groups")
stargazer(m7, type = "text")
cf <- data.frame(summary(m7)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))


print("model with 5 groups")
stargazer(m7_1, type = "text")
cf1 <- data.frame(summary(m7_1)$coefficients[, 1])
colnames(cf1) <- c("probability")
print("probability coefficients")
print(logit2prob(cf1))

```
Clinically groups is marginally significantly influence the gamble acceptance compared to HC in model with no interaction effect: the depression group is more likely to accept the gambles. The effect does not exist when use the random effect (1|ID).

And $group4$ and $group5$ have the same influence.

### the model with the an individual subject level variable
$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + group4 + VAR + (block|ID)$$
```{r level1Var & demo, echo=FALSE}
m_education2 <- update(m7, .~. + scale(EDUCATION))
m_income2 <- update(m7, .~. + scale(IncomePerCapita))
m_exit2 <- update(m7, .~. + scale(EXIT))
m_mmse2 <- update(m7, .~. + scale(MMSE))
m_nonplan2 <- update(m7, .~. + scale(BIS_NONPLAN))
m_urgency2 <- update(m7, .~. + scale(urgency))
m_interpersonal2 <- update(m7, .~. + scale(IIP15INTAMBV))

print("EXIT model")
stargazer(m_exit2, type = "text")
cf <- data.frame(summary(m_exit2)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))


print("NONPLAN model")
stargazer(m_nonplan2, type = "text")
cf1 <- data.frame(summary(m_nonplan2)$coefficients[, 1])
colnames(cf1) <- c("probability")
print("probability coefficients")
print(logit2prob(cf1))


```
$EXIT$ is the only significant subject level variable. The higher $EXIT$, less likely to accept the gambles.

Controlling the $nonplan$ variable, the depression group is more significantly likely to accept gamble compared to the HC. 

## models with interaction effect
Fit specific interaction models. From higher order to lower.

$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + group4 + INTERACTION + (block|ID)$$

1.  $ReappraisalDirection$ x $scale(totalStake)$ x $Fairness\,score$ x $group4$ four way interaction effect, and see if the model is significant. If not, drop this interaction.

```{r 4way interaction, include=FALSE}
m9_4interaction <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + ReappraisalDirection * scale(totalStake) * Fairness_score * group4 + (block|ID), data = allData, family = binomial, glmerControl(calc.derivs = FALSE, optCtrl = list(maxfun = 2e4)))

stargazer(m9_4interaction)
cf <- data.frame(summary(m9_4interaction)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
It failed to converge at 4 way interaction

2. $ReappraisalDirection$ x $Fairness\,score$ x $group4$ three way interaction
```{r 3way interaction, include=FALSE}
m9_3interaction1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + ReappraisalDirection * Fairness_score * group4 + (block|ID), data = allData, family = binomial, glmerControl(calc.derivs = FALSE, optCtrl = list(maxfun = 2e4)))
```
It failed to converge.

3. $Reappraisal\,Direction$ x $scale(total\,Stake)$ x $group4$ three way interaction
```{r, echo=FALSE}
m9_3interaction <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + ReappraisalDirection * scale(totalStake) * group4 + (block|ID), data = allData, family = binomial, glmerControl(calc.derivs = FALSE, optCtrl = list(maxfun = 2e4)))

stargazer(m9_3interaction, type = "text")
cf <- data.frame(summary(m9_3interaction)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
Reappraisal Direction x totalStake x group4 is marginally significant. The attempter is more likely to accept the gambles under empathy context, but the depression is more likely to accept the gambles under the punish context, as the total stake size increases.

4. $fairness\, score$ x $group4$ two way interaction
```{r pairwise interaction, echo=FALSE}
m9_2interaction1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score * group4 + (block|ID), data = allData, family = binomial, glmerControl(calc.derivs = FALSE, optCtrl = list(maxfun = 2e4)))

stargazer(m9_2interaction1, type = "text")
cf <- data.frame(summary(m9_2interaction1)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
Fairness score x group has significant interaction effect. The attempter is less likely to accept gambles as the unfairness increases, the depression is more likely.

5. $reappraisal\, direction$ x $group4$ two way interaction
```{r, echo=FALSE}
m9_2interaction2 <- glmer(allData$AcceptOffer ~ scale(totalStake) + Fairness_score + ReappraisalDirection * group4 + (block|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))

stargazer(m9_2interaction2, type = "text")
cf <- data.frame(summary(m9_2interaction2)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
reappraisal direction x group4 has significant influence. The depression is more likely to accept the gambles in both punish and empathy context.

6. $total\, stake$ x $group4$ two way interaction
```{r}
m9_2interaction4 <- glmer(allData$AcceptOffer ~ scale(totalStake) + ReappraisalDirection + Fairness_score + group4 + scale(totalStake) * group4 + (block|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))

stargazer(m9_2interaction4, type = "text")
cf <- data.frame(summary(m9_2interaction4)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))
print(logit2OR(cf))

```
total stake x group4 has significant influence. The depression and the attempter are more likely to accept tha gambles as the stake size increase.

7. $total\, stake$ x $fairness\, score$ two way interaction
```{r, echo=FALSE}
m9_2interaction5 <- glmer(allData$AcceptOffer ~ scale(totalStake) + ReappraisalDirection + Fairness_score + group4 + scale(totalStake) * Fairness_score + (block|ID), data = allData, family = binomial, control = glmerControl(optimizer = "bobyqa"))

stargazer(m9_2interaction5, type = "text")
cf <- data.frame(summary(m9_2interaction5)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
total stake x fairness score has significant influence. As the stake size increase, more gambles are accepted even the unfairness increase.

**which interaction model is the best model among all the interaction models:**
```{r best interaction model, echo=FALSE}
modellist2 <- model.sel(m9_3interaction, m9_2interaction1, m9_2interaction2, m9_2interaction3, m9_2interaction4, m9_2interaction5)
print(modellist2)
```
The best interaction model is $Reappraisal\,Direction$ x $scale(total\,Stake)$ x $group4$ 3 way interaction.

**the (best) interaction model with the subject level variable**
$$Accept\,Offer = Reappraisal\,Direction + scale(total\,Stake) + Fairness\,score + group4 + \\Reappraisal\,Direction * scale(total\,Stake) * group4 + VAR + (block|ID)$$
```{r, echo=FALSE}
m_education3 <- update(m9_3interaction, .~. + scale(EDUCATION))
m_income3 <- update(m9_3interaction, .~. + scale(IncomePerCapita))
m_exit3 <- update(m9_3interaction, .~. + scale(EXIT))
m_mmse3 <- update(m9_3interaction, .~. + scale(MMSE))
m_nonplan3 <- update(m9_3interaction, .~. + scale(BIS_NONPLAN))
m_urgency3 <- update(m9_3interaction, .~. + scale(urgency))
m_interpersonal3 <- update(m9_3interaction, .~. + scale(IIP15INTAMBV))

stargazer(m_exit3, type = "text")
cf <- data.frame(summary(m_exit3)$coefficients[, 1])
colnames(cf) <- c("probability")
print("probability coefficients")
print(logit2prob(cf))

```
Only $EXIT$ has significant influence. The higher $EXIT$, the less likely to accept the gambles. The depression group is more likely to accept regardless of context, as the stake size increase. The attempter only accept more gambles under empathy context, as the stake size increases.


Compare (1|ID) and (block|ID) $EXIT$ models:
```{r, echo=FALSE}
modellist3 <- model.sel(m_exit, m_exit1, m_exit2, m_exit3)
print(modellist3)
```