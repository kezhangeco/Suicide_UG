---
title: "UG_HLM"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# set up enviornment
library(lme4)
library(ggplot2)
library(GGally)
library(plyr)
library(Matrix)
library(nlme)
library(readxl)
library(reshape2)
library(VIF)
library(numDeriv)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
# is fairness ratio orthogonal with stake size?

task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
task$totalStake <- task$PlayerProposedAmount + task$OpponentProposedAmount
corr <- cor(task$Fairness_score, task$PlayerProposedAmount)
corr1 <- cor(task$Fairness_score, task$OpponentProposedAmount)
corr2 <- cor(task$Fairness_score, task$totalStake)
print(corr)
print(corr1)
print(corr2)
```

```{r}
# demographics and questionnaires plots on distribution and correlations between predictors
# describe predictors by clinical groups
# DRS and Household income: r = 0.398, HRSD NO SUI & age = -0.25, HRSD NO SUI & Household income = r = -0.27

task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
demo <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_demog.xlsx")
question <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_questionnaire.xlsx")
demoQuestion <- merge(demo, question, on = "ID")

# Continous predictors
ggpairs(demoQuestion[, c("PROTECT2AGE", "HOUSEHOLD INCOME", "HRSD NO SUI", "DRS")])

# by groups
tmp <- melt(demoQuestion[, c("group4", "PROTECT2AGE", "HOUSEHOLD INCOME", "HRSD NO SUI", "DRS")], id.vars = "group4")
tmp1 <- melt(demoQuestion[, c("group5", "PROTECT2AGE", "HOUSEHOLD INCOME", "HRSD NO SUI", "DRS")], id.vars = "group5")

ggplot(tmp, aes(factor(group4), y = value, fill = factor(group4))) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_y")

ggplot(tmp1, aes(factor(group5), y = value, fill = factor(group5))) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_y")

```

```{r}

# UG models data clean
 
#task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
#demo <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_demog.xlsx")
#question <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_questionnaire.xlsx")

task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
demo <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_demog.xlsx")
question <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_questionnaire.xlsx")

demoQuestion <- merge(demo, question, on = "ID")
allData <- merge(task, demoQuestion, on = "ID")
allData$totalStake <- allData$PlayerProposedAmount + allData$OpponentProposedAmount

allData <- rename(allData, c("HOUSEHOLD INCOME" = "HouseholdIncome", "HRSD NO SUI" = "HRSD_NO_SUI", "PER CAPITA INCOME" = "IncomePerCapita"))

# rescale and center continuous parameters, because there are large differences in the scales of parameters.
# scale() = (value - mean)/sd
predictors <- c("HRSD_NO_SUI", "PROTECT2AGE", "HouseholdIncome", "totalStake", "IncomePerCapita")
rescaled_predictors = scale(allData[, predictors])

# replace the scaled predictors into the original dataframe
allData_scaled <- allData
allData_scaled[predictors] <- rescaled_predictors 

```

```{r}
# multicollinearity
df = allData[, c("HRSD_NO_SUI", "group4", "PROTECT2AGE", "HouseholdIncome", "GENDERTEXT", "RACETEXT", "ReappraisalDirection", "totalStake", "Fairness_score", "DRS")]
df = df[complete.cases(df$DRS), ]

x=vif(df)
print(x)
```

```{r}
# test if HLM is needed: whether there is variation over the level 2 variable: participant ID
# task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")

# intercept only
interceptOnly <- glm(task$AcceptOffer ~ 1, family = binomial, data = task)

# random intercept only
randomInterceptOnly <- glmer(task$AcceptOffer ~ 1 + (1|ID), data = task, family = binomial)

print(summary(interceptOnly))
cat("BIC of no subject type variation", BIC(interceptOnly))
print(summary(randomInterceptOnly))

```

```{r}
# exam level 2 participant variable "participants clinical type" influence on acceptance
m_group4 <- glmer(allData$AcceptOffer ~ group4 + (1|ID), data = allData, family = binomial)
print(summary(m_group4))

```

```{r}
# exam level 2 participant variable "participants clinical type" influence on acceptance
m_group5 <- glmer(allData$AcceptOffer ~ group5 + (1|ID), data = allData, family = binomial)
print(summary(m_group5))

```

```{r}
# exam level 2 participant variable "age" influence on acceptance
m_age <- glmer(allData_scaled$AcceptOffer ~ PROTECT2AGE + (1|ID), data = allData_scaled, family = binomial)
print(summary(m_age))

```

```{r}
# exam level 2 participant variable "HRSD NO SUI" influence on acceptance
m_depress <- glmer(allData$AcceptOffer ~ HRSD_NO_SUI + (1|ID), data = allData, family = binomial)
print(summary(m_depress))
```

```{r}
# exam level 2 participant variable "household income" influence on acceptance
m_income1 <- glmer(allData$AcceptOffer ~ scale(HouseholdIncome) + (1|ID), data = allData, family = binomial)
print(summary(m_income1))
```

```{r}
# exam level 2 participant variable "household income" influence on acceptance
m_income2 <- glmer(allData$AcceptOffer ~ scale(IncomePerCapita) + (1|ID), data = allData, family = binomial)
print(summary(m_income2))

```

```{r}
# exam level 2 participant variable "gender" influence on acceptance
m_gender <- glmer(allData$AcceptOffer ~ GENDERTEXT + (1|ID), data = allData, family = binomial)
print(summary(m_gender))
```

```{r}
# exam level 2 participant variable "race" influence on acceptance
m_race <- glmer(allData$AcceptOffer ~ RACETEXT + (1|ID), data = allData, family = binomial)
print(summary(m_race))
```

```{r}
# exam level 1 participant variable "framing" influence on acceptance
m_framing <- glmer(allData$AcceptOffer ~ ReappraisalDirection + (1|ID), data = allData, family = binomial)
print(summary(m_framing))

```

```{r}
# exam level 1 participant variable "total stake size" influence on acceptance
m_stakeSize <- glmer(allData$AcceptOffer ~ totalStake + (1|ID), data = allData, family = binomial)
print(summary(m_stakeSize))
```

```{r}
# exam level 1 participant variable "fairness score" influence on acceptance
m_fair <- glmer(allData$AcceptOffer ~ Fairness_score + (1|ID), data = allData, family = binomial)
print(summary(m_fair))
```

```{r}
# random intercept, fixed predictors at level 1
m0 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + (1|ID), data = allData, family = binomial)
print(summary(m0))
```

```{r}
## random intercept, fixed predictors at level 1 and 2
# with scaled continous predictors
m1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + scale(PROTECT2AGE) + scale(HRSD_NO_SUI) + scale(HouseholdIncome) * RACETEXT + GENDERTEXT + (1|ID), data = allData, family = binomial, optimizer="bobyqa")
print(summary(m1))

# double check the gradient calculations and convergence test. See if the inconvergence matter.
derivs1 <- m1@optinfo$derivs
m1_grad <- with(derivs1, solve(Hessian, gradient))
max(abs(m1_grad))
print("gradient > 0.001, the inconvergence is worriesome")
```

```{r}
# random intercept (at level 1), random slope (at level 2 variables)
# Level 1 variables do not vary across participants ID, as all participant had the same task, and the types of task do not vary across PID. Hence a random slope models (the following models) are not necessary.

m1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + (ReappraisalDirection|ID), data = allData, family = binomial)
print(summary(m1))

m2 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + (totalStake|ID), data = allData, family = binomial)
print(summary(m2))
```

```{r}
# random intercept, level 1 and level 2 predictors 
m3 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + Gender + income + PROTECT2AGE + group4 + (1 + ReappraisalDirection|ID), data = allData, family = binomial)
print(summary(m3))

```


```{r}
# testing sample data
hdp <- read.csv("https://stats.idre.ucla.edu/stat/data/hdp.csv")
hdp1 <- within(hdp, {
  Married <- factor(Married, levels = 0:1, labels = c("no", "yes"))
  DID <- factor(DID)
  HID <- factor(HID)
})

ggpairs(hdp[, c("IL6", "CRP", "LengthofStay", "Experience")])

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
