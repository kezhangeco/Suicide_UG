---
title: "UG_HLM"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
# is fairness ratio orthogonal with stake size?

task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
task$totalStake <- task$PlayerProposedAmount + task$OpponentProposedAmount
corr <- cor(task$Fairness_score, task$PlayerProposedAmount)
corr1 <- cor(task$Fairness_score, task$OpponentProposedAmount)
corr2 <- cor(task$Fairness_score, task$totalStake)
print(corr)
print(corr1)
print(corr2)
```

```{r}
# demographics and questionnaires plots on distribution and correlations between predictors
# describe predictors by clinical groups
# DRS and Household income: r = 0.398, HRSD NO SUI & age = -0.25, HRSD NO SUI & Household income = r = -0.27

library(lme4)
library(readxl)
library(ggplot2)
library(GGally)
task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
demo <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_demog.xlsx")
question <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_questionnaire.xlsx")
demoQuestion <- merge(demo, question, on = "ID")

# Continous predictors
ggpairs(demoQuestion[, c("PROTECT2AGE", "HOUSEHOLD INCOME", "HRSD NO SUI", "DRS")])

# by groups
tmp <- melt(demoQuestion[, c("group4", "PROTECT2AGE", "HOUSEHOLD INCOME", "HRSD NO SUI", "DRS")], id.vars = "group4")
tmp1 <- melt(demoQuestion[, c("group5", "PROTECT2AGE", "HOUSEHOLD INCOME", "HRSD NO SUI", "DRS")], id.vars = "group5")

ggplot(tmp, aes(factor(group4), y = value, fill = factor(group4))) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_y")
ggplot(tmp1, aes(factor(group5), y = value, fill = factor(group5))) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_y")

```

```{r}
library(plyr)
library(lme4)
library(Matrix)
library(nlme)
library(readxl)
# UG models data clean
 
task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
demo <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_demog.xlsx")
question <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_questionnaire.xlsx")
demoQuestion <- merge(demo, question, on = "ID")
allData <- merge(task, demoQuestion, on = "ID")
allData$totalStake <- allData$PlayerProposedAmount + allData$OpponentProposedAmount
allData <- rename(allData, c("HOUSEHOLD INCOME" = "HouseholdIncome", "HRSD NO SUI" = "HRSD_NO_SUI", "PER CAPITA INCOME" = "IncomePerCapita"))
```

```{r}
# test if HLM is needed: whether there is variation over the level 2 variable: participant ID
# task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")

# intercept only
interceptOnly <- glm(task$AcceptOffer ~ 1, family = binomial, data = task)

# random intercept only
randomInterceptOnly <- glmer(task$AcceptOffer ~ 1 + (1|ID), data = task, family = binomial)

print(summary(interceptOnly))
cat("BIC of no subject type variation", BIC(interceptOnly))
print(summary(randomInterceptOnly))

```

```{r}
# exam level 2 participant variable "participants clinical type" influence on acceptance
m_group4 <- glmer(allData$AcceptOffer ~ group4 + (1|ID), data = allData, family = binomial)
print(summary(m_group4))

```

```{r}
# exam level 2 participant variable "participants clinical type" influence on acceptance
m_group5 <- glmer(allData$AcceptOffer ~ group5 + (1|ID), data = allData, family = binomial)
print(summary(m_group5))
```

```{r}
# exam level 2 participant variable "age" influence on acceptance
m_age <- glmer(allData$AcceptOffer ~ PROTECT2AGE + (1|ID), data = allData, family = binomial)
print(summary(m_age))
```

```{r}
# exam level 2 participant variable "HRSD NO SUI" influence on acceptance
m_depress <- glmer(allData$AcceptOffer ~ HRSD_NO_SUI + (1|ID), data = allData, family = binomial)
print(summary(m_depress))
```

```{r}
# exam level 2 participant variable "household income" influence on acceptance
m_income1 <- glmer(allData$AcceptOffer ~ HouseholdIncome + (1|ID), data = allData, family = binomial)
print(summary(m_income1))
```

```{r}
# exam level 2 participant variable "household income" influence on acceptance
m_income2 <- glmer(allData$AcceptOffer ~ IncomePerCapita + (1|ID), data = allData, family = binomial)
print(summary(m_income2))
```

```{r}
# exam level 2 participant variable "gender" influence on acceptance
m_gender <- glmer(allData$AcceptOffer ~ GENDERTEXT + (1|ID), data = allData, family = binomial)
print(summary(m_gender))
```

```{r}
# exam level 2 participant variable "race" influence on acceptance
m_race <- glmer(allData$AcceptOffer ~ RACETEXT + (1|ID), data = allData, family = binomial)
print(summary(m_race))
```

```{r}
# random intercept, fixed predictors at level 1
m0 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + (1|ID), data = allData, family = binomial)
print(summary(m0))
```

```{r}
# random intercept (at level 1), random slope (at level 2 variables)
# Level 1 variables do not vary across participants ID, as all participant had the same task, and the types of task do not vary across PID. Hence a random slope models (the following models) are not necessary.

m1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + (ReappraisalDirection|ID), data = allData, family = binomial)
print(summary(m1))

m2 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + (totalStake|ID), data = allData, family = binomial)
print(summary(m2))
```

```{r}
# random intercept, level 1 and level 2 predictors 
m3 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + totalStake + Fairness_score + Gender + income + PROTECT2AGE + group4 + (1 + ReappraisalDirection|ID), data = allData, family = binomial)
print(summary(m3))

```



```{r}
# testing sample data
library(ggplot2)
library(GGally)

hdp <- read.csv("https://stats.idre.ucla.edu/stat/data/hdp.csv")
hdp1 <- within(hdp, {
  Married <- factor(Married, levels = 0:1, labels = c("no", "yes"))
  DID <- factor(DID)
  HID <- factor(HID)
})

ggpairs(hdp[, c("IL6", "CRP", "LengthofStay", "Experience")])

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
