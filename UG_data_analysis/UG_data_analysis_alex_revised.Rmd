---
title: "UG_data_analysis1"
author: "Ke"
date: '2018-01-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
# library(GGally)
library(plyr)
library(Matrix)
library(readxl)
library(reshape2)
library(numDeriv)
library(MuMIn)
# library(glmulti)
# library(rJava)
library(mice)
library(stargazer)
library(lsmeans)
library(effects)
library(psych)
library(compareGroups)
```


```{r data, include = FALSE}
# import data
#task <- read.csv("/home/kzhang5/scratch/ug_all_task_data.csv")
#demo <- read_excel("/home/kzhang5/scratch/ug_demog.xlsx")
#question <- read_excel("/home/kzhang5/scratch/ug_questionnaire.xlsx")
#
#task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
#demo <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_demog.xlsx")
#question <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_questionnaire.xlsx")


task <- read.csv("~/code/Suicide_UG/ug_all_task_data.csv")
demo <- read_excel("~/code/Suicide_UG/ug_demog.xlsx")
question <- read_excel("~/code/Suicide_UG/ug_questionnaire.xlsx")

question <- rename(question, c("UPPSP NEG URGENCY" = "urgency"))
demoQuestion <- merge(demo, question, on = "ID")

c1 <- demoQuestion[,c(2,3,15,49,93,129,78,79)]
c2 <- compareGroups(c1,demoQuestion$group4)
t1 <- createTable(c2,hide = NA, hide.no = 0, digits = 1, show.n = TRUE)

allData <- merge(task, demoQuestion, on = "ID")
allData$totalStake <- allData$PlayerProposedAmount + allData$OpponentProposedAmount
allData <- rename(allData, c("HOUSEHOLD INCOME" = "HouseholdIncome", "HRSD NO SUI" = "HRSD_NO_SUI", "PER CAPITA INCOME" = "IncomePerCapita", "MMSE TOTAL" = "MMSE"))
allData$Fairness_score <- as.factor(allData$Fairness_score)
allData$ID <- as.factor(allData$ID)
allData$AcceptOffer <- as.factor(allData$AcceptOffer)

# reference group = control
allData <- within(allData, group4 <- relevel(group4, ref = "attempter"))
allData <- within(allData, group5 <- relevel(group5, ref = "AttempterHL"))

# block number
allData$block <- NA
allData$block <- ifelse(allData$merged_trial < 27, "1", ifelse((allData$merged_trial > 26) & (allData$merged_trial < 53), "2", "3" ))
print(allData$block)

allData$fairLR <- log(allData$PlayerProposedAmount/allData$OpponentProposedAmount)
allData$fairR <- (allData$PlayerProposedAmount/allData$OpponentProposedAmount)

df <- allData
save(list = ls(all.names = TRUE), file = "UG1.RData")

```

variables in the models:
 - Reappraisal Direction
 - total stake
 - Fairness score
 - clinical groups
 - education
 - IncomePerCapita
 - EXIT (4 missing values)
 - trial number (within block number)
 - block number
 - an impulsivity measure: BIS_NONPLAN (3 missing values)/UPPS negative urgency
 - an interpersonal function measure: IIP15INTAMBV (4 missing values)

```{r missing values, include=FALSE}
# complete missing values
# check how many percentage of data is missing in the question dataframe
pMiss <- function(x){sum(is.na(x))/length(x)*100}
missingVar <- c('ID', 'BIS_NONPLAN', 'IIP15INTAMBV', 'EXIT', 'urgency')
missingDF <- question[, missingVar]
apply(question[missingVar], 2, pMiss)
print(md.pattern(question[missingVar]))

# impute data
missingDF_impute <- mice(missingDF, m = 5, meth = "pmm", maxit = 50)
print(summary(missingDF_impute))
missingVar_complete <- complete(missingDF_impute,1)

# merge the generated values to the df
missingVar_complete <- rename(missingVar_complete, c("BIS_NONPLAN" = "BIS_NONPLAN_full", "IIP15INTAMBV" = "IIP15INTAMBV_full", "EXIT" = "EXIT_full", "urgency" = "urgency_full"))
allData <- merge(allData, missingVar_complete, by = "ID")
df <- allData
```
# correlation matrix of the subject level variables
```{r corr, echo=FALSE}
corrMatrix <- ggpairs(demoQuestion[, c("PER CAPITA INCOME", "HRSD NO SUI", "DRS", "EDUCATION", "EXIT", "BIS_NONPLAN", "IIP15INTAMBV", "urgency")])
```
The following variables are moderately/highly correlated:
- DRS x income
- **education x income**
- education x DRS
- EXIT x DRS
- **EXIT x education**
- **BIS nonplan x income**
- BIS nonplan x HSD
- **interpersonal x BIS nonplan**
- urgency x HSD
- urgency x BIS nonplan
- **urgency x interpersonal**

```{r}
m0 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + (1|ID/block), family = binomial, data = allData,  
  control = glmerControl(optimizer = "bobyqa"))

summary(m0)
# convergence problems with Fairness_score
plot(df$Fairness_score, df$fairLR)
m0r <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + fairLR + (1|ID/block), family = binomial, data = allData, 
  control = glmerControl(optimizer = "bobyqa"))
summary(m0r)
car::Anova(m0r)
anova(m0,m0r)
lsm <- lsmeans(m0r, "ReappraisalDirection")
plot(lsm, horiz = F)
plot(Effect("totalStake",m0r))
plot(Effect("fairLR",m0r))

m1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection*fairLR*scale(totalStake) + (1|ID/block), family = binomial, data = allData,   
control = glmerControl(optimizer = "bobyqa"))
summary(m1)
car::Anova(m1)
anova(m0r,m1)
lsm <- lsmeans(m1, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
lsm <- lsmeans(m1, "fairLR", by = "totalStake", at = list(totalStake = c(8, 13,18), fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)


# Group
m1g <-glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 |
  ID/block),
  family = binomial,
  data = allData,
  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1g)
car::Anova(m1g)
anova(m1,m1g)
pdf("UGcontext*group.pdf", width=8, height=6)
lsm <- lsmeans(m1g, "ReappraisalDirection", by = "group4")
plot(lsm, horiz = F)
dev.off()
pdf("UGfair*group.pdf", width=8, height=6)
lsm <- lsmeans(m1g, "fairLR", by = "group4", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()
pdf("UGstake*group.pdf", width=8, height=6)
lsm <- lsmeans(m1g, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
dev.off()


# NB: there are RT outliers up to 430s (??).  Try without the top 5%:
m1g_cens <- glmer(
  AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 |
  ID/block),
  family = binomial,
  data = allData[allData$Stimuli_RT<5823,],
  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1g_cens)
car::Anova(m1g_cens)
# results are not sensitive to that

## tried context*fair*Group -- too complex, would not bother including
# control for MMSE
m1gm <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(MMSE) + (1 |
  ID),
  family = binomial,
  data = allData,
    
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gm)
car::Anova(m1gm, type = 'III')
pdf("UGcontext*MMSE.pdf", width=8, height=6)
lsm <- lsmeans(m1gm, "ReappraisalDirection", by = "MMSE", at = list(MMSE = c(26,28,30)))
plot(lsm, horiz = F)
dev.off()
```

```{r}
```
# control for MMSE
m1gm <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(MMSE) + (1 |
  ID),
  family = binomial,
  data = allData,
    
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gm)
car::Anova(m1gm, type = 'III')
pdf("UGcontext*MMSE.pdf", width=8, height=6)
lsm <- lsmeans(m1gm, "ReappraisalDirection", by = "MMSE", at = list(MMSE = c(26,28,30)))
plot(lsm, horiz = F)
dev.off()

# IRI_EMPATHETIC_CONCERN

m1gi <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(IRI_EMPATHETIC_CONCERN) + (1 |
  ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gi)
car::Anova(m1gi, type = 'III')
pdf("UGcontext*IRIemp.pdf", width=12, height=6)
lsm <- lsmeans(m1gi, "ReappraisalDirection", by = "IRI_EMPATHETIC_CONCERN", at = list(IRI_EMPATHETIC_CONCERN = c(8,20,25)))
plot(lsm, horiz = F)
dev.off()

pdf("UGcontext*group_adjusted_IRIemp.pdf", width=8, height=6)
lsm <- lsmeans(m1gi, "ReappraisalDirection", by = "group4")
plot(lsm, horiz = F)
dev.off()

# Interpersonal aggression and sensitivity
m1ga <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(IIP15AGRESS) + (1 |
  ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1ga)
car::Anova(m1ga, type = 'III')
pdf("UGcontext*IIPaggr.pdf", width=12, height=6)
lsm <- lsmeans(m1ga, "ReappraisalDirection", by = "IIP15AGRESS", at = list(IIP15AGRESS = c(0,4,11)))
plot(lsm, horiz = F)
dev.off()

m1gs <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(IIP15INTSEN) + (1 |
  ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1ga)
car::Anova(m1ga, type = 'III')
pdf("UGcontext*IIPsens.pdf", width=12, height=6)
lsm <- lsmeans(m1gs, "ReappraisalDirection", by = "IIP15INTSEN", at = list(IIP15INTSEN = c(0,4,11)))
plot(lsm, horiz = F)
dev.off()

m1gex <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(IIP15INTSEN) + (1 |
  ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1ga)
car::Anova(m1ga, type = 'III')
pdf("UGcontext*EXIT.pdf", width=12, height=6)
lsm <- lsmeans(m1gs, "ReappraisalDirection", by = "IIP15INTSEN", at = list(IIP15INTSEN = c(3,5,10)))
plot(lsm, horiz = F)
dev.off()



# with lethality
m1gl <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5  + (1 |
  ID/block),
  family = binomial,
  data = allData,
   
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gl)
car::Anova(m1gl)
anova(m1g,m1gl)
pdf("UGcontext*groupLeth.pdf", width=10, height=6)
lsm <- lsmeans(m1gl, "ReappraisalDirection", by = "group5")
plot(lsm, horiz = F)
dev.off()
pdf("UGfair*groupLeth.pdf", width=10, height=6)
lsm <- lsmeans(m1gl, "fairLR", by = "group5", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()

# try to replicate previous UG paper
m1gl1 <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5  + scale(fairLR) * scale(totalStake) * group5 + (1 |
  ID/block),
  family = binomial,
  data = allData,
   nAGQ = 0,
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gl1)
car::Anova(m1gl1)
anova(m1gl,m1gl1)

pdf("UGfair*stake*groupLeth.pdf", width=14, height=6)
lsm <- lsmeans::lsmeans(m1gl, "fairLR", by = c("totalStake", "group5"), at = list(fairLR = c(-2.66,0.22),totalStake = c(8,18)))
plot(lsm, horiz = F)
dev.off()


```

## RT analyses
Screening the alternative models of the level 1 predictors. The models include all interaction effect.
```{r}
rt1 <- lmer(
  Stimuli_RT ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 |
  ID/block),
  data = allData[allData$Stimuli_RT<5823 & allData$Stimuli_RT>250,])
  summary(rt1)
car::Anova(rt1)

pdf("RTcontext*group.pdf", width=8, height=6)
lsm <- lsmeans::lsmeans(rt1, "ReappraisalDirection", by = "group4")
plot(lsm, horiz = F)
dev.off()
pdf("RTfair*group.pdf", width=8, height=6)
lsm <- lsmeans::lsmeans(rt1, "fairLR", by = "group4", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()
pdf("RTstake*group.pdf", width=8, height=6)
lsm <- lsmeans::lsmeans(rt1, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
dev.off()

```
```{r}
m_education3 <- update(m9_3interaction, .~. + scale(EDUCATION))
m_income3 <- update(m9_3interaction, .~. + scale(IncomePerCapita))
m_exit3 <- update(m9_3interaction, .~. + scale(EXIT))
m_mmse3 <- update(m9_3interaction, .~. + scale(MMSE))
m_nonplan3 <- update(m9_3interaction, .~. + scale(BIS_NONPLAN))
m_urgency3 <- update(m9_3interaction, .~. + scale(urgency))
m_interpersonal3 <- update(m9_3interaction, .~. + scale(IIP15INTAMBV))

summary(m_exit3)
```

Only $EXIT$ has significant influence. 

Compare (1|ID) and (block|ID) models:
```{r}
modellist3 <- model.sel(m_exit, m_exit1, m_exit2, m_exit3)
print(modellist3)
```