---
title: "UG_data_analysis1"
author: "Ke"
date: '2018-01-15'
output: html_document

# based on ALex's suggestion
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(GGally)
library(plyr)
library(Matrix)
library(readxl)
library(reshape2)
library(numDeriv)
library(MuMIn)
library(glmulti)
library(rJava)
library(mice)
library(readxl)
library(VIF)
library(numDeriv)
library(MuMIn)
library(DHARMa)
library(bitops)
library(nloptr)
library(optimx)
library(dfoptim)
library(emmeans)
library(afex)
library(usdm)
library(broom)
```


```{r data, include = FALSE}
# import data
#task <- read.csv("/home/kzhang5/scratch/ug_all_task_data.csv")
#demo <- read_excel("/home/kzhang5/scratch/ug_demog.xlsx")
#question <- read_excel("/home/kzhang5/scratch/ug_questionnaire.xlsx")

#task <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv")
#demo <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_demog.xlsx")
#question <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_questionnaire.xlsx")

task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
demo <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_demog.xlsx")
question <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_questionnaire.xlsx")

question <- rename(question, c("UPPSP NEG URGENCY" = "urgency"))
demoQuestion <- merge(demo, question, on = "ID")
allData <- merge(task, demoQuestion, on = "ID")
allData$totalStake <- allData$PlayerProposedAmount + allData$OpponentProposedAmount
allData <- rename(allData, c("HOUSEHOLD INCOME" = "HouseholdIncome", "HRSD NO SUI" = "HRSD_NO_SUI", "PER CAPITA INCOME" = "IncomePerCapita", "MMSE TOTAL" = "MMSE"))
allData$Fairness_score <- as.factor(allData$Fairness_score)
allData$ID <- as.factor(allData$ID)
allData$AcceptOffer <- as.factor(allData$AcceptOffer)

# block number
allData$framingContext <- NA
allData$framingContext[allData$ReappraisalDirection == "punish"] <- "framing"
allData$framingContext[allData$ReappraisalDirection == "empathy"] <- "framing"
allData$framingContext[allData$ReappraisalDirection == "baseline"] <- "baseline"

```


# predictors:
## - Reappraisal Direction
## - total stake
## - Fairness score
## - clinical groups
## - education
## - IncomePerCapita
## - EXIT (4 missing values)
## - trial number (within block number)
## - block number
## - an impulsivity measure: BIS_NONPLAN (3 missing values)/UPPS negative urgency
## - an interpersonal function measure: IIP15INTAMBV (4 missing values)

# complete missing values
```{r missing values}
# check how many percentage of data is missing in the question dataframe
pMiss <- function(x){sum(is.na(x))/length(x)*100}
missingVar <- c('ID', 'BIS_NONPLAN', 'IIP15INTAMBV', 'EXIT', 'urgency')
missingDF <- question[, missingVar]
apply(question[missingVar], 2, pMiss)
print(md.pattern(question[missingVar]))

# impute data
missingDF_impute <- mice(missingDF, m = 5, meth = "pmm", maxit = 50)
print(summary(missingDF_impute))
missingVar_complete <- complete(missingDF_impute,1)

# merge the generated values to the df
missingVar_complete <- rename(missingVar_complete, c("BIS_NONPLAN" = "BIS_NONPLAN_full", "IIP15INTAMBV" = "IIP15INTAMBV_full", "EXIT" = "EXIT_full", "urgency" = "urgency_full"))
allData <- merge(allData, missingVar_complete, by = "ID")
```

# Whether HLM is needed?
## Intercept only
```{r}
interceptOnly <- glm(task$AcceptOffer ~ 1, family = binomial, data = task)
print(summary(interceptOnly))
```

## Null model: random intercept only
```{r}
randomInterceptOnly <- glmer(task$AcceptOffer ~ 1 + (1|ID), data = task, family = binomial)
print(summary(randomInterceptOnly))
```
By adding the ID (nested), the AIC (1|D) is smaller than the AIC (1). So HLM is necessary. 

The variance of the intercept in the *null model is 1.157*. That is the variance can't be explained by the random effect of ID. Compare the variance with more complicated models. If the intercept variance gets smaller, that is an indication of the additional predictors adding more explanation to the DV.

##  Intraclass Correlation (ICC)
Test if HLM is needed: whether there is variation over the level 2 variable (participant ID). If the ICC > 0, then HLM is needed.
```{r}
ICC_model <- function(modelName) {
  tau_null <- as.numeric(lapply(summary(modelName)$varcor, diag))
  sigma_null <- as.numeric(attr(summary(modelName)$varcor, "sc")^2)
  ICC_null <- tau_null/(tau_null + sigma_null)
  return(ICC_null)
}

cat("ICC is", ICC_model(randomInterceptOnly))
```
The ICC > 0, the HLM is needed.

```{r wrapper, include=FALSE}
glmer.glmulti <- function(formula, data, random = ""){
  glmer(paste(deparse(formula), random), data = data, family = binomial, control = glmerControl(calc.derivs = FALSE))
}
```

# Level 1 model
## Random intercept and fixed slopes with random effect (1|ID)

$$
AcceptOffer = ReappraisalDirection + scale(totalStake) + Fairness_score + (1|ID)
$$

## Level 1 model without interaction effect 
All the alternative models are:
```{r}
m1_level1 <- glmulti(allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * Fairness_score, level = 1, fitfunction = glmer.glmulti, random = "+ (1|ID)", method = "g", data = allData, confsetsize = 8)

m1_models <- weightable(m1_level1)
print(m1_models)
```

The best model of the no interaction model is:
```{r}
m0 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + (1|ID), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"))

summary(m0)
```

## Level 1 model with interaction effect 
```{r}
m1 <- glmulti(allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * Fairness_score, level = 2, fitfunction = glmer.glmulti, random = "+ (1|ID)", method = "g", data = allData)

# look at the models
m1_models <- weightable(m1)
print(m1_models)

```

# Level 1 model with $group$ predictor

## No interaction model
```{r}
m3 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + group4 + (1|ID), family = binomial, data = allData)
summary(m3)
```

## Interaction models:
$ReappraisalDirection * scale(totalStake) * Fairness_score * group4$ 4 way interaction effect, and see if the model is significant. If not, drop this interaction
```{r}
m2_4interaction <- glmer(allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * Fairness_score * group4 + (1|ID), data = allData, family = binomial, glmerControl(optCtrl = list(maxfun = 100000)))

summary(m2_4interaction)
```

The 4 way interaction is not significant.

Screening all alternative models of the level 1 + group models
```{r}
m2 <- glmulti(allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * Fairness_score * group4, level = 2, fitfunction = glmer.glmulti, random = "+ (1|ID)", method = "g", data = allData)

m2_1 <- glmulti(allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * Fairness_score * group5, level = 2, fitfunction = glmer.glmulti, random = "+ (1|ID)", method = "g", data = allData)

m2_models <- weightable(m2)
print(m2_models)
```



# correlation matrix 
```{r corr}
corrMatrix <- ggpairs(demoQuestion[, c("PER CAPITA INCOME", "HRSD NO SUI", "DRS", "EDUCATION", "EXIT", "BIS_NONPLAN", "IIP15INTAMBV", "urgency")])
```
The following variables are moderately/highly correlated:
- DRS x income
- **education x income**
- education x DRS
- EXIT x DRS
- **EXIT x education**
- **BIS nonplan x income**
- BIS nonplan x HSD
- **interpersonal x BIS nonplan**
- urgency x HSD
- urgency x BIS nonplan
- **urgency x interpersonal**

# Level 1 model + individual subject level variable
# 
$$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + VAR + (1|ID)$$

```{r}
m_education <- update(m0, .~. + scale(EDUCATION))
m_income <- update(m0, .~. + scale(IncomePerCapita))
m_exit <- update(m0, .~. + scale(EXIT))
m_mmse <- update(m0, .~. + scale(MMSE))
m_nonplan <- update(m0, .~. + scale(BIS_NONPLAN))
m_urgency <- update(m0, .~. + scale(urgency))
m_interpersonal <- update(m0, .~. + scale(IIP15INTAMBV))

summary(m_exit)
summary(m_mmse)
summary(m_education)
summary(m_income)
summary(m_nonplan)
summary(m_urgency)
summary(m_interpersonal)
```

The following predictor does not have significant influence on the model:
education, income per capita, m_nonplan, m_urgency, interpersonal

EXIT is a better predictor than MMSE.

```{r}

```

