---
title: "UG_data_analysis1"
author: "Ke"
date: '2018-01-15'
outputs: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
# library(GGally)
library(plyr)
library(Matrix)
library(readxl)
library(reshape2)
library(numDeriv)
library(MuMIn)
# library(glmulti)
# library(rJava)
library(mice)
library(stargazer)
library(lsmeans)
library(effects)
library(psych)
library(compareGroups)
library(afex)
library(stargazer)

```


```{r data, include = FALSE}
# import data
#task <- read.csv("/home/kzhang5/scratch/ug_all_task_data.csv")
#demo <- read_excel("/home/kzhang5/scratch/ug_demog.xlsx")
#question <- read_excel("/home/kzhang5/scratch/ug_questionnaire.xlsx")

#task <- read.csv("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_all_task_data.csv")
#demo <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_demog.xlsx")
#question <- read_excel("C:\\Users\\ke\\ownCloud\\Suicide_UG\\UG_clean_updated\\ug_questionnaire.xlsx")

task <- read.csv('/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_all_task_data.csv')
demo <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_demog.xlsx")
question <- read_excel("/Users/kezhang/ownCloud/Suicide_UG/UG_clean_updated/ug_questionnaire.xlsx")
emoRating <- read.csv("/Users/kezhang/ownCloud/Suicide_UG/raw_data_backup/post_survey_master_data_frame.csv")

#task <- read.csv("~/code/Suicide_UG/ug_all_task_data.csv")
#demo <- read_excel("~/code/Suicide_UG/ug_demog.xlsx")
#question <- read_excel("~/code/Suicide_UG/ug_questionnaire.xlsx")

question <- rename(question, c("UPPSP NEG URGENCY" = "urgency"))
demoQuestion <- merge(demo, question, on = "ID")

# compare the group differences
c1 <- demoQuestion[,c(2,3,15,49,93,129,78,79)]
myVar <- c("EDUCATION", "GENDERTEXT", "PROTECT2AGE", "RACETEXT", "MMSE TOTAL", "WTARSS", "DRS", "EXIT", "BIS_NONPLAN", "urgency", "IIP15INTAMBV")
c1_1 <- demoQuestion[myVar]
c2 <- compareGroups(c1,demoQuestion$group4)
c2_2 <- compareGroups(c1_1, demoQuestion$group4)
c2_3 <- compareGroups(c1_1, demoQuestion$group5)
t1 <- createTable(c2,hide = NA, hide.no = 0, digits = 1, show.n = TRUE)
t1_1 <- createTable(c2_2,hide = NA, hide.no = 0, digits = 1, show.n = TRUE)
t1_2 <- createTable(c2_3,hide = NA, hide.no = 0, digits = 1, show.n = TRUE)

allData <- merge(task, demoQuestion, on = "ID")
#fairPercept <- subset(AvgEmoRating, AvgEmoRating$ReappraisalDirection == "unfair")
#allData <- merge(allData, fairPercept, by="ID")
allData$totalStake <- allData$PlayerProposedAmount + allData$OpponentProposedAmount
allData <- rename(allData, c("HOUSEHOLD INCOME" = "HouseholdIncome", "HRSD NO SUI" = "HRSD_NO_SUI", "PER CAPITA INCOME" = "IncomePerCapita", "MMSE TOTAL" = "MMSE"))
allData$Fairness_score <- as.numeric(allData$Fairness_score)
allData$ID <- as.factor(allData$ID)
allData$AcceptOffer <- as.factor(allData$AcceptOffer)
allData$Trial_Number <- as.factor(allData$Trial_Number)

# reference group = control
allData <- within(allData, group4 <- relevel(group4, ref = "attempter"))
allData <- within(allData, group5 <- relevel(group5, ref = "AttempterHL"))

# block number
allData$block <- NA
allData$block <- ifelse(allData$merged_trial < 27, "1", ifelse((allData$merged_trial > 26) & (allData$merged_trial < 53), "2", "3" ))

# fairness ratio
allData$fairLR <- log(allData$PlayerProposedAmount/allData$OpponentProposedAmount)
allData$fairR <- (allData$PlayerProposedAmount/allData$OpponentProposedAmount)

# separate groups
depression <- subset(allData, group4 == "depression")
control <- subset(allData, group4 == "control")
ideator <- subset(allData, group4 == "ideator")
attempter <- subset(allData, group4 == "attempter")
attHL <- subset(allData, group4 == "AttempterHL")
attLL <- subset(allData, group4 == "AttempterLL")

# merge individual variables in the post survey df
Pgroup <- demo[,c("ID", "group4", "group5")]
emoRating <- merge(emoRating, Pgroup, by = "ID")
emoRating$ID <- as.factor(emoRating$ID)
emoRating$group4 <- as.factor(emoRating$group4)
emoRating$group5 <- as.factor(emoRating$group5)

Pvars <- allData[, c("ID", "MMSE", "PROTECT2AGE", "GENDERTEXT", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION", "RACETEXT", "WTARSS", "DRS", "EXIT", "BIS_NONPLAN", "urgency", "IIP15INTAMBV", "IIP15INTSEN", "IIP15AGRESS", "IRI_EMPATHETIC_CONCERN")]
Pvars <- subset(Pvars, !duplicated(ID))
emoRating <- merge(emoRating, Pvars, by = "ID")
emoRating$ReappraisalDirection[emoRating$ReappraisalDirection == 1] <- "punish"
emoRating$ReappraisalDirection[emoRating$ReappraisalDirection == 2] <- "empathy"
emoRating$ReappraisalDirection <- as.factor(emoRating$ReappraisalDirection)

```

variables in the models:
 - Reappraisal Direction
 - total stake
 - Fairness score
 - clinical groups
 - education
 - IncomePerCapita
 - EXIT (4 missing values)
 - trial number (within block number)
 - block number
 - an impulsivity measure: BIS_NONPLAN (3 missing values)/UPPS negative urgency
 - an interpersonal function measure: IIP15INTAMBV (4 missing values)
 
```{r rm missing values, include = False}
missingVar <- c('ID', 'BIS_NONPLAN', 'IIP15INTAMBV', 'EXIT', 'urgency')

```

```{r missing values, include=FALSE}
# complete missing values
# check how many percentage of data is missing in the question dataframe
pMiss <- function(x){sum(is.na(x))/length(x)*100}
missingVar <- c('ID', 'BIS_NONPLAN', 'IIP15INTAMBV', 'EXIT', 'urgency')
missingDF <- question[, missingVar]
apply(question[missingVar], 2, pMiss)
print(md.pattern(question[missingVar]))

# impute data
missingDF_impute <- mice(missingDF, m = 5, meth = "pmm", maxit = 50)
print(summary(missingDF_impute))
missingVar_complete <- complete(missingDF_impute,1)

# merge the generated values to the df
missingVar_complete <- rename(missingVar_complete, c("BIS_NONPLAN" = "BIS_NONPLAN_full", "IIP15INTAMBV" = "IIP15INTAMBV_full", "EXIT" = "EXIT_full", "urgency" = "urgency_full"))
allData <- merge(allData, missingVar_complete, by = "ID")
df <- allData
```


# correlation matrix of the subject level variables
```{r corr, echo=FALSE}
corrMatrix <- ggpairs(demoQuestion[, c("PER CAPITA INCOME", "HRSD NO SUI", "DRS", "EDUCATION", "EXIT", "BIS_NONPLAN", "IIP15INTAMBV", "urgency")])
```
The following variables are moderately/highly correlated:
- DRS x income
- **education x income**
- education x DRS
- EXIT x DRS
- **EXIT x education**
- **BIS nonplan x income**
- BIS nonplan x HSD
- **interpersonal x BIS nonplan**
- urgency x HSD
- urgency x BIS nonplan
- **urgency x interpersonal**

# models$1|ID|block$
$$offer = reappraisal\,direction & stake & fairness$$
```{r}
m0 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + Fairness_score + (1|ID/block), family = binomial, data = allData,  
  control = glmerControl(optimizer = "bobyqa"))
summary(m0)

plot(df$Fairness_score, df$fairLR)

m0r <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + fairLR + (1|ID/block), family = binomial, data = allData, 
  control = glmerControl(optimizer = "bobyqa"))
summary(m0r)
car::Anova(m0r)
anova(m0,m0r)
lsm <- lsmeans(m0r, "ReappraisalDirection")
plot(lsm, horiz = F)
plot(Effect("totalStake",m0r), axes = list(y=list(lab = "P(accept)", type = "response", lim = c(0,1))), multiline = TRUE, rug = FALSE)
plot(Effect("fairLR",m0r), axes = list(y=list(lab = "P(accept)", type = "response", lim = c(0,1))), multiline = TRUE, rug = FALSE)

m1 <- glmer(allData$AcceptOffer ~ ReappraisalDirection*fairLR*scale(totalStake) + (1|ID/block), family = binomial, data =
              allData, control = glmerControl(optimizer = "bobyqa"))
summary(m1)
car::Anova(m1)
anova(m0r,m1)
lsm <- lsmeans(m1, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
lsm <- lsmeans(m1, "fairLR", by = "totalStake", at = list(totalStake = c(8, 13,18), fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
lsm <- lsmeans(m1, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))

```
The $ReappraisalDirection*fairLR*scale(totalStake)$ is the best fit model.

$$offer = reappraisal\,direction & stake & fairness & groups$$
```{r}
# 4 way interaction: ReappraisalDirection * scale(fairLR) * scale(totalStake) * group. Too complex to converge. 
#m1_4way <- glmer(allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) * group4 +  (1 | ID/block), family = binomial, data = allData, control = glmerControl(optimizer = "bobyqa"), optCtrl = list(maxfun = 2e4))


# Group interaction
m1g <-glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1g)
car::Anova(m1g)
anova(m1,m1g)
pdf("UGcontext*group.pdf", width=8, height=6)
lsm <- lsmeans(m1g, "ReappraisalDirection", by = "group4")
plot(lsm, horiz = F)
dev.off()
pdf("UGfair*group.pdf", width=8, height=6)
lsm <- lsmeans(m1g, "fairLR", by = "group4", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()
pdf("UGstake*group.pdf", width=8, height=6)
lsm <- lsmeans(m1g, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
dev.off()


# NB: there are RT outliers up to 430s (??).  Try without the top 5%:
m1g_cens <- glmer(
  AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 |
  ID/block),
  family = binomial,
  data = allData[allData$Stimuli_RT<5823,],
  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1g_cens)
car::Anova(m1g_cens)
# results are not sensitive to that
## tried context*fair*Group -- too complex, would not bother including

```

```{r control MMSE}
# no missing values
# control for MMSE with (1 | ID)
m1gm <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection
  *group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + ReappraisalDirection*scale(MMSE) + (1|ID),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gm)
car::Anova(m1gm, type = 'III')
pdf("UGcontext*MMSE.pdf", width=8, height=6)
lsm <- lsmeans(m1gm, "ReappraisalDirection", by = "MMSE", at = list(MMSE = c(26,28,30)))
plot(lsm, horiz = F)
dev.off()

# control for MMSE with (1 | ID/block)
m1gm_1 <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + ReappraisalDirection*scale(MMSE) + (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))
summary(m1gm)
car::Anova(m1gm, type = 'III')
pdf("UGcontext*MMSE.pdf", width=8, height=6)
lsm <- lsmeans(m1gm, "ReappraisalDirection", by = "MMSE", at = list(MMSE = c(26,28,30)))
plot(lsm, horiz = F)
dev.off()

anova(m1gm, m1gm_1)
```

```{r control IRI}
# IRI_EMPATHETIC_CONCERN
## Interpersonal Reactivity Index - Empathetic Concern subscale

m1gi <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +
    ReappraisalDirection*scale(IRI_EMPATHETIC_CONCERN) + (1 | ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gi)
car::Anova(m1gi, type = 'III')
pdf("UGcontext*IRIemp.pdf", width=12, height=6)
lsm <- lsmeans(m1gi, "ReappraisalDirection", by = "IRI_EMPATHETIC_CONCERN", at = list(IRI_EMPATHETIC_CONCERN = c(8,20,25)))
plot(lsm, horiz = F)
dev.off()

pdf("UGcontext*group_adjusted_IRIemp.pdf", width=8, height=6)
lsm <- lsmeans(m1gi, "ReappraisalDirection", by = "group4")
plot(lsm, horiz = F)
dev.off()

```

```{r control interpersonal}
# Interpersonal aggression and sensitivity
m1ga <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(IIP15AGRESS) + (1 | ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1ga)
car::Anova(m1ga, type = 'III')
pdf("UGcontext*IIPaggr.pdf", width=12, height=6)
lsm <- lsmeans(m1ga, "ReappraisalDirection", by = "IIP15AGRESS", at = list(IIP15AGRESS = c(0,4,11)))
plot(lsm, horiz = F)
dev.off()


m1gex <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + 
      ReappraisalDirection*scale(IIP15INTSEN) + (1 | ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,  
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gex)
car::Anova(m1gex, type = 'III')
pdf("UGcontext*IIPsens.pdf", width=12, height=6)
lsm <- lsmeans(m1gs, "ReappraisalDirection", by = "IIP15INTSEN", at = list(IIP15INTSEN = c(3,5,10)))
plot(lsm, horiz = F)
dev.off()

```

```{r control lethality}
# with lethality by group5
m1gl <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5  + (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa"))
  summary(m1gl)
car::Anova(m1gl)
anova(m1g,m1gl)
pdf("UGcontext*groupLeth.pdf", width=10, height=6)
lsm <- lsmeans(m1gl, "ReappraisalDirection", by = "group5")
plot(lsm, horiz = F)
dev.off()
pdf("UGfair*groupLeth.pdf", width=10, height=6)
lsm <- lsmeans(m1gl, "fairLR", by = "group5", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()
```

```{r replica}
# try to replicate previous UG paper (group x magnitude x fairness)
m1gl1 <-
  glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5  + scale(fairLR) * scale(totalStake) * group5 +
    (1 | ID/block),
  family = binomial,
  data = allData,
  nAGQ = 0,
  control = glmerControl(optimizer = "bobyqa"))
summary(m1gl1)
car::Anova(m1gl1)

pdf("UGfair*stake*groupLeth.pdf", width=14, height=6)
lsm <- lsmeans(m1gl1, "fairLR", by = c("totalStake", "group5"), at = list(fairLR = c(-2.66,0.22),totalStake = c(8,18)))
plot(lsm, horiz = F)
lsm <- lsmeans(m1gl1, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
lsm <- lsmeans(m1gl1, "totalStake", by = "group5", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)

```

## RT analyses
Screening the alternative models of the level 1 predictors. The models include all interaction effect.
```{r}
rt1 <- lmer(
  Stimuli_RT ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 |
  ID/block),
  data = allData[allData$Stimuli_RT<5823 & allData$Stimuli_RT>250,])
  summary(rt1)
car::Anova(rt1)

pdf("RTcontext*group.pdf", width=8, height=6)
lsm <- lsmeans::lsmeans(rt1, "ReappraisalDirection", by = "group4")
plot(lsm, horiz = F)
dev.off()
pdf("RTfair*group.pdf", width=8, height=6)
lsm <- lsmeans::lsmeans(rt1, "fairLR", by = "group4", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()
pdf("RTstake*group.pdf", width=8, height=6)
lsm <- lsmeans::lsmeans(rt1, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
dev.off()

save.image("ouput.RData")
```

## KE's code
# Punishing type 
```{r, clean punishing data}
# Punishing type has two type
punishMaster <- subset(allData, (allData$PunishingType == "reputation") | (allData$PunishingType == "resources"))

punishMaster$PunishingType <- factor(punishMaster$PunishingType)
levels(punishMaster$PunishingType) <- c("reputation", "resources")
unique(punishMaster$PunishingType)
```

# level 1 model
$$AcceptOffer <- PunishingType + scale(totalStake) + Fairness\,score$$
$$AcceptOffer <- PunishingType + scale(totalStake) + fairLR$$
```{r, punish level 1}
modelPun1_fairScore <- glmer(punishMaster$AcceptOffer ~ PunishingType + scale(totalStake) + 
                          scale(Fairness_score) + (1|ID/block),
                          family = binomial, data = punishMaster, 
                          control = glmerControl(optimizer = "bobyqa"))
  
modelPun1_fairLR <- glmer(punishMaster$AcceptOffer ~ PunishingType + scale(totalStake) + 
                          scale(fairLR) + (1|ID/block),
                          family = binomial, data = punishMaster, 
                          control = glmerControl(optimizer = "bobyqa"))

car::Anova(modelPun1_fairScore)
anova(modelPun1_fairScore,modelPun1_fairLR)

lsm <- lsmeans(modelPun1_fairLR, "PunishingType")
plot(lsm, horiz = F)
plot(Effect("totalStake",modelPun1_fairLR), axes = list(y=list(lab = "P(accept)", type = "response", lim = c(0,1))), multiline = TRUE, rug = FALSE)
plot(Effect("fairLR",modelPun1_fairLR), axes = list(y=list(lab = "P(accept)", type = "response", lim = c(0,1))), multiline = TRUE, rug = FALSE)

# interaction
modelL1 <- glmer(AcceptOffer ~ PunishingType*scale(fairLR)*scale(totalStake) + (1|ID/block), 
                 family = binomial, data = punishMaster, control = glmerControl(optimizer = "bobyqa"))
stargazer(modelL1, type = "html", title = "AcceptOffer ~ PunishingType*scale(fairLR)*scale(totalStake) + (1|ID/block)", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/PunishingType*fairLR*totalStake.htm")
lsm <- lsmeans(modelL1, "PunishingType")
plot(lsm, horiz = F)

```

# level1 + level2 with groups
```{r, group4 interaction}
# 4 way interaction: PunishingType * scale(fairLR) * scale(totalStake) * group. Too complex to converge. 
#model4way <- glmer(AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) * group4 +  (1 | ID/block), family = binomial, data = punishMaster, control = glmerControl(optimizer = "bobyqa"), optCtrl = list(maxfun = 2e4))


# Group4 interaction
modelPun1g <-glmer(
  AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 | ID/block),
  family = binomial,
  data = punishMaster,
  control = glmerControl(optimizer = "bobyqa"))

stargazer(modelPun1g, type = "text", title = "AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType * group4 + scale(fairLR) * group4 + scale(totalStake) * group4 +  (1 | ID/block)", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/interaction_group4.txt")

car::Anova(modelPun1g)
anova(modelL1,modelPun1g)

jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/punishingType*group4.jpg")
lsm <- lsmeans(modelPun1g, "PunishingType", by = "group4")
plot(lsm, horiz = F)
dev.off()

jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/fairLR*group4.jpg")
lsm <- lsmeans(modelPun1g, "fairLR", by = "group4", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
dev.off()

jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/totalStake*group4.pdf.jpg")
lsm <- lsmeans(modelPun1g, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
dev.off()

```

```{r, lethality group5 interaction}
# Group interaction
modelPun1g <-glmer(
  AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5 +  (1 | ID/block),
  family = binomial,
  data = punishMaster,
  control = glmerControl(optimizer = "bobyqa"))

stargazer(modelPun1g, type = "text", title = "AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType * group5 + scale(fairLR) * group5 + scale(totalStake) * group5 +  (1 | ID/block)", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/interaction_group5.txt")

car::Anova(modelPun1g)
anova(modelL1,modelPun1g)

jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/punishType*group5.jpg")
lsm <- lsmeans(modelPun1g, "PunishingType", by = "group5")
plot(lsm, horiz = F) +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    facet_grid(~ group5)
dev.off()

jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/fairLR*group5.jpg")
lsm <- lsmeans(modelPun1g, "fairLR", by = "group5", at = list(fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)

jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/NoIndividual/totalStake*group5.pdf.jpg")
lsm <- lsmeans(modelPun1g, "totalStake", by = "group5", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
dev.off()
```

```{r, control MMSE}
# no missing values
# control for MMSE with (1 | ID)
modelPun1_mg <-
  glmer(
  AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType
  *group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + PunishingType*scale(MMSE) + (1|ID),
  family = binomial,
  data = punishMaster,
  control = glmerControl(optimizer = "bobyqa"))

stargazer(modelPun1_mg, type = "text")
summary(modelPun1_mg)
car::Anova(modelPun1_mg, type = 'III')
jpeg("punishType*MMSE_ind.jpg")
lsm <- lsmeans(modelPun1_mg, "PunishingType", by = "MMSE", at = list(MMSE = c(26,28,30)))
plot(lsm, horiz = F)
dev.off()

# control for MMSE with (1 | ID/block)
## better than (1|ID)
## PunishingType*scale(MMSE)
modelPun2_mg <-
  glmer(
  punishMaster$AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + PunishingType*scale(MMSE) + (1 | ID/block),
  family = binomial,
  data = punishMaster,
  control = glmerControl(optimizer = "bobyqa"))

summary(modelPun2_mg)
stargazer(modelPun2_mg, type = "text", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*MMSE_ind.txt")
car::Anova(modelPun2_mg, type = 'III')
anova(modelPun2_mg, modelPun1_mg)
jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*MMSE_ind.jpg")
lsm <- lsmeans(modelPun2_mg, "PunishingType", by = "MMSE", at = list(MMSE = c(26,28,30)))
plot(lsm, horiz = F)
dev.off()

# PunishingType*scale(MMSE)*group4
modelPun3_mg <-
  glmer(
  punishMaster$AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) + PunishingType *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + PunishingType*scale(MMSE)*group4 + (1 | ID/block),
  family = binomial,
  data = punishMaster,
  control = glmerControl(optimizer = "bobyqa"))

stargazer(modelPun3_mg, type = "text", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group4*MMSE_ind.txt")

lsm <- lsmeans(modelPun3_mg, "PunishingType", by = c("MMSE", "group4"), at = list(MMSE = c(26,28,30)))
jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group4*MMSE_ind.jpg")
plot(lsm, horiz = F) +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  facet_grid(~ MMSE+group4)
dev.off()
anova(modelPun3_mg, modelPun2_mg)
```

```{r, control lethality group5}
# PunishingType*scale(MMSE)*group5
# can't converge
#modelPun5_mg <-
#  glmer(
#  punishMaster$AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) +  PunishingType* 
#  group5 + scale(fairLR) * group5 + scale(totalStake) * group5
#  +PunishingType*scale(MMSE)*group5 + (1 | ID/block),
#  family = binomial,
#  data = punishMaster,
#  control = glmerControl(optimizer = "bobyqa"), optCtrl = list(maxfun = 2e4))
 

# PunishingType*scale(MMSE)
modelPun4_mg <-
  glmer(
  punishMaster$AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*
    group5 + scale(fairLR) * group5 + scale(totalStake) * group5
    +PunishingType*scale(MMSE) + (1 | ID/block),
    family = binomial,
    data = punishMaster,
    control = glmerControl(optimizer = "bobyqa"))
stargazer(modelPun4_mg, type = "text", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group5*MMSE_ind.txt")
lsm <- lsmeans(modelPun4_mg, "PunishingType", by = c("MMSE", "group5"), at = list(MMSE = c(26,28,30)))
jpeg("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group5*MMSE_ind.jpg")
plot(lsm, horiz = F) +
  theme(axis.text.x=element_text(angle=90, hjust=1))+
  facet_grid(~ MMSE + group5) 

```

```{r, individual vars group4}
VarLoopDF <- punishMaster[, c("MMSE", "PROTECT2AGE", "GENDERTEXT", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION", "BIS_NONPLAN", "urgency", "IIP15INTAMBV", "IIP15INTSEN", "IIP15AGRESS", "IRI_EMPATHETIC_CONCERN")]

# scale punish df individual factors, rm categorical vars and missing value vars
scaleVarLs <- scale(VarLoopDF[, c("MMSE", "PROTECT2AGE", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION")])

#scaleVarLsDF <- scale(scaleVarLs)
punishMasterScale <- punishMaster
punishMasterScale[, c("MMSE", "PROTECT2AGE", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION")] <- scaleVarLs

# variables list without/with the missing value variables
varlist_complete <- list("MMSE", "EDUCATION", "IncomePerCapita", "PROTECT2AGE", "HRSD_NO_SUI")
varlist_missing <- list('BIS_NONPLAN', 'IIP15AGRESS','IIP15INTSEN', 'IIP15INTAMBV', 'urgency', "IRI_EMPATHETIC_CONCERN")

## PunishingType*vars
### output models
modelPun1_2way <- lapply(varlist_complete, function(individualFactor) {
  models <- glmer(substitute(AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*group4 + scale(fairLR) * group4 + scale(totalStake) * group4
    + PunishingType*i + (1 | ID/block), 
    list(i = as.name(individualFactor))),
    data = punishMasterScale,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))
    return(stargazer(models, type = "text", title = paste("AcceptOffer ~ PunishingType * fairLR * totalStake +  PunishingType*group4 + fairLR * group4 + totalStake * group4 + PunishingType*", individualFactor, "+ (1 | ID/block)"), out = paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*", individualFactor, ".txt")))
})

### output models graphs
pltFunPun1_2way <- lapply(varlist_complete, function(individualFactor) {
  models <- glmer(substitute(AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*group4 + scale(fairLR) * group4 + scale(totalStake) * group4
    + PunishingType*i + (1 | ID/block), 
    list(i = as.name(individualFactor))),
    data = punishMasterScale,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))

    vars <- (punishMasterScale[, individualFactor])
    print(class(vars))
    intervalLength <- ifelse(class(vars) == "numeric", (max(vars) - min(vars))/5, list(unique(vars)))
    print(intervalLength)
    lvls <- ifelse(class(vars) == "numeric", list(seq(from=min(vars), to=max(vars)), by = intervalLength), intervalLength)
    jpeg(paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*",
               individualFactor,".jpg"))
    lsm <- lsmeans(models, "PunishingType", by = c(individualFactor, "group4"), at = list(individualFactor = lvls)) 
    plot(lsm, horiz = F) +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    facet_grid(~ individualFactor+group4) +
    ggtitle(paste("AcceptOffer ~ PunishingType * fairLR * totalStake +
    PunishingType*group4 + fairLR * group4 + totalStake * group4
    + PunishingType*",individualFactor, "+ (1 | ID/block)"))
    dev.off()
    
})

## PunishingType*vars*group4
### output models
modelPun1_3way <- lapply(varlist_complete, function(individualFactor) {
  models <- glmer(substitute(AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*group4 + scale(fairLR) * group4 + scale(totalStake) * group4
    + PunishingType*group4*i + (1 | ID/block), 
    list(i = as.name(individualFactor))),
    data = punishMasterScale,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa"))
    return(stargazer(models, type = "text", title = paste("AcceptOffer ~ PunishingType * fairLR * totalStake +  PunishingType*group4 + fairLR * group4 + totalStake * group4 + PunishingType*group4*", individualFactor, "+ (1 | ID/block)"), out = paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group4*", individualFactor, ".txt")))
})

### output models graphs
pltFunPun1_3way <- lapply(varlist_complete, function(individualFactor) {
  models <- glmer(substitute(AcceptOffer ~ PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*group4 + scale(fairLR) * group4 + scale(totalStake) * group4
    + PunishingType*group4*i + (1 | ID/block), 
    list(i = as.name(individualFactor))),
    data = punishMasterScale,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))
    
    print(individualFactor)
    vars <- (punishMasterScale[, individualFactor])
    print(vars)
    print(class(vars))
    #intervalLength <- ifelse(class(vars) == "numeric", (max(vars) - min(vars))/2, list(unique(vars)))
    #print(intervalLength)
    lvls <- ifelse(class(vars) == "numeric", list(seq(min(vars), max(vars), length.out = 3)), list(unique(vars)))
    print(lvls)
    jpeg(file = paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group4*",individualFactor,".jpg"))
    lsm <- lsmeans(models, "PunishingType", by = c(individualFactor, "group4"), at = list(individualFactor = lvls)) 
    plt <- plot(lsm, horiz = F) +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    facet_grid(as.formula(paste(". ~", paste(individualFactor, "+ group4")))) +
    ggtitle(paste("AcceptOffer ~ PunishingType * fairLR * totalStake +
    PunishingType*group4 + fairLR * group4 + totalStake * group4
    + PunishingType*group4*",individualFactor, "+ (1 | ID/block)"))
    dev.off()
    print(plt)
    return(plt)
})


```

```{r, individual vars group5}
## PunishingType*vars*group5
### output models
modelPun2_3way <- lapply(varlist_complete, function(individualFactor) {
  models <- glmer(substitute(PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*group5 + scale(fairLR) * group5 + scale(totalStake) * group5
    + PunishingType*group5*i + (1 | ID/block), 
    list(i = as.name(individualFactor))),
    data = punishMasterScale,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))
    return(stargazer(models, type = "text", title = paste("AcceptOffer ~ PunishingType * fairLR * totalStake +  PunishingType*group5 + fairLR * group5 + totalStake * group5 + PunishingType*group5*", x, "+ (1 | ID/block)"), out = paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group5*", individualFactor, ".txt")))
})

### output models graphs
pltFunPun2_3way <- lapply(varlist, function(individualFactor) {
  models <- glmer(substitute(PunishingType * scale(fairLR) * scale(totalStake) +
    PunishingType*group5 + scale(fairLR) * group5 + scale(totalStake) * group5
    + PunishingType*group5*i + (1 | ID/block), 
    list(i = as.name(individualFactor))),
    data = punishMasterScale,
    family = binomial,
    control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))

    vars <- (punishMaster[, individualFactor])
    print(class(vars))
    intervalLength <- ifelse(class(vars) == "numeric", (max(vars) - min(vars))/5, list(unique(vars)))
    print(intervalLength)
    lvls <- ifelse(class(vars) == "numeric", seq(from=min(vars), to=max(vars), by = intervalLength), intervalLength)
    jpeg(paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/punishType/punishType*group5*",
               individualFactor,".jpg"))
    lsm <- lsmeans(models, "PunishingType", by = c(individualFactor, "group5"), at = list(individualFactor = lvls)) 
    plt <- plot(lsm, horiz = F) +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    facet_grid(~ individualFactor+group5) +
    ggtitle(paste("AcceptOffer ~ PunishingType * fairLR * totalStake +
    PunishingType*group5 + fairLR * group5 + totalStake * group5
    + PunishingType*group5*",individualFactor, "+ (1 | ID/block)"))
    dev.off()
    return(plt)
})
```

# post-survey analysis 
```{r fairness perception describe}
# whether fairness perception differ between groups by reappraisal direction
punish <- subset(emoRating, emoRating$ReappraisalDirection == "punish")
empathy <- subset(emoRating, emoRating$ReappraisalDirection == "empathy")

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity_punish_group5.jpg')
boxplot(punish$Rating ~ punish$group5)
dev.off()
ano5_punish <-aov(punish$Rating ~ punish$group5)
summary(ano5_punish)
tk5_punish <- TukeyHSD(ano5_punish)
print(tk5_punish)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity_empathy_group5.jpg')
boxplot(empathy$Rating ~ empathy$group5)
dev.off()
ano5_empathy <-aov(empathy$Rating ~ empathy$group5)
summary(ano5_empathy)
tk5_empathy <- TukeyHSD(ano5_empathy)
print(tk5_empathy)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity_punish_group4.jpg')
boxplot(punish$Rating ~ punish$group4)
dev.off()
ano4_punish <-aov(punish$Rating ~ punish$group4)
summary(ano4_punish)
tk4_punish <- TukeyHSD(ano4_punish)
print(tk4_punish)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity_empathy_group4.jpg')
boxplot(empathy$Rating ~ empathy$group4)
dev.off()
ano4_empathy <-aov(empathy$Rating ~ empathy$group4)
summary(ano4_empathy)
tk4_empathy <- TukeyHSD(ano4_empathy)
print(tk4_empathy)
```


```{r post survey TRY}
# ER = emotional reactivity: ER4(group4), ER5(group5)
## fairness_perception x group x stake size

# group4
m0ER4 <- glmer(allData$AcceptOffer ~ ReappraisalDirection + scale(totalStake) + fairLR + reactivity + group4 + (1|ID/block), family = binomial, data = allData, 
  control = glmerControl(optimizer = "bobyqa"))
summary(m0ER4)
car::Anova(m0ER4)
lsm <- lsmeans(m0ER4, "ReappraisalDirection")
plot(lsm, horiz = F)
plot(Effect("totalStake",m0ER4), axes = list(y=list(lab = "P(accept)", type = "response", lim = c(0,1))), multiline = TRUE, rug = FALSE)
plot(Effect("fairLR",m0ER4), axes = list(y=list(lab = "P(accept)", type = "response", lim = c(0,1))), multiline = TRUE, rug = FALSE)

m1ER4 <-glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + scale(totalStake)*scale(reactivity)*group4 + (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/totalStake*reactivity*group4_1.jpg')
lsm <- lsmeans(m1ER4, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/totalStake*reactivity*group4_2.jpg')
lsm <- lsmeans(m1ER4, "fairLR", by = "totalStake", at = list(totalStake = c(8, 13,18), fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F) 
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/totalStake*reactivity*group4_3.jpg')

lsm <- lsmeans(m1ER4, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F) 
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/totalStake*reactivity*group4_4.jpg')

lsm <- lsmeans(m1ER4, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F) 

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*totalStake*group4.jpg')
lsm <- lsmeans(m1ER4, "reactivity", by = c("group4", "totalStake"), at = list(reactivity = c(1,3,5), totalStake = c(8,18)))
plot(lsm, horiz = F) +
  facet_grid(. ~ group4 + totalStake)
dev.off()

m2ER4 <-glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(fairLR) * scale(totalStake) + ReappraisalDirection *
  group4 + scale(fairLR) * group4 + scale(totalStake) * group4 + scale(reactivity)*group4 + (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*group4_1.jpg')
lsm <- lsmeans(m2ER4, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*group4_2.jpg')
lsm <- lsmeans(m2ER4, "fairLR", by = "totalStake", at = list(totalStake = c(8, 13,18), fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*group4_3.jpg')

lsm <- lsmeans(m2ER4, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*group4_4.jpg')
lsm <- lsmeans(m2ER4, "totalStake", by = "group4", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)



# group5
m1ER5 <-glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * scale(fairLR) + ReappraisalDirection *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5 +  scale(reactivity) * scale(totalStake) * group5 + (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*totalStake*group5_1.jpg')
lsm <- lsmeans(m1ER5, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*totalStake*group5_2.jpg')
lsm <- lsmeans(m1ER5, "fairLR", by = "totalStake", at = list(totalStake = c(8, 13,18), fairLR = c(-2.66,-1.22,0.22)))
plot(lsm, horiz = F) +
  facet_grid(. ~ totalStake)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*totalStake*group5_3.jpg')
lsm <- lsmeans(m1ER5, "ReappraisalDirection", by = "totalStake", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F) +
  facet_grid(. ~ totalStake)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*totalStake*group5_4.jpg')
lsm <- lsmeans(m1ER5, "totalStake", by = "group5", at = list(totalStake = c(8, 13,18)))
plot(lsm, horiz = F) +
  facet_grid(. ~ group5)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity*totalStake*group5.jpg')
lsm <- lsmeans(m1ER5, "reactivity", by = c("group5", "totalStake"), at = list(reactivity = c(1,3,5), totalStake = c(8,18)))
plot(lsm, horiz = F) +
  facet_grid(. ~ group5 + totalStake)
dev.off()

# don't converge
m2ER5 <-glmer(
  allData$AcceptOffer ~ ReappraisalDirection * scale(totalStake) * scale(fairLR) + ReappraisalDirection *
  group5 + scale(fairLR) * group5 + scale(totalStake) * group5 +  scale(reactivity) * scale(totalStake) * group5 * scale(fairLR) + (1 | ID/block),
  family = binomial,
  data = allData,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e4)))


```

```{r post survey HLM?}
## HLM necessary?
interceptOnly <- glm(Rating ~ 1, family = gaussian, data = reactivity)
print(summary(interceptOnly))

### Null model: random intercept only
randomInterceptOnly <- glmer(Rating~ 1 + (1|ID), data = reactivity, family = gaussian)
print(summary(randomInterceptOnly))

ICC_model <- function(modelName) {
  tau_null <- as.numeric(lapply(summary(modelName)$varcor, diag))
  sigma_null <- as.numeric(attr(summary(modelName)$varcor, "sc")^2)
  ICC_null <- tau_null/(tau_null + sigma_null)
  return(ICC_null)
}
cat("ICC is", ICC_model(randomInterceptOnly))

```
HLM is needed.

```{r, reactivity model}
# compare reactivity to empathy, punishment across groups

## scale(Rating) ~ ReappraisalDirection + group4 + (1|ID)
m2React4 <- lmer(
  scale(Rating) ~ ReappraisalDirection + group4 + (1|ID), data = emoRating)

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4Reappraisal.jpg')
lsm <- lsmeans(m2React4, "ReappraisalDirection", by = c("group4"))
plot(lsm, horiz = F) +
  facet_grid(. ~ group4)
dev.off()
mEff <- allEffects(m2React4)
plot(mEff, axes = list(y = list(lab = "reactivity")))
stargazer(summary(m2React4)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection + group4 + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4Reappraisal.htm")
stargazer(summary(m2React4)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection + group4 + (1|ID)")
    

m2React5 <- lmer(
  scale(Rating) ~ ReappraisalDirection + group5 + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5Reappraisal.jpg')
lsm <- lsmeans(m2React5, "ReappraisalDirection", by = c("group5"))
plot(lsm, horiz = F) +
  facet_grid(. ~ group5)
dev.off()
mEff <- allEffects(m2React5)
plot(mEff, axes = list(y = list(lab = "reactivity")))
stargazer(summary(m2React5)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection + group5 + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5Reappraisal.htm")


# scale(Rating) ~ ReappraisalDirection*group4+(1|ID)
m3React4 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group4 + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4*Reappraisal.jpg')
lsm <- lsmeans(m3React4, "ReappraisalDirection", by = c("group4"))
plot(lsm, horiz = F) +
  facet_grid(. ~ group4)
dev.off()
mEff <- allEffects(m3React4)
plot(mEff, axes = list(y = list(lab = "reactivity")))
summary(m3React4)
stargazer(summary(m3React4)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group4 + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4*Reappraisal.htm")


m3React5 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group5 + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5*Reappraisal.jpg')
lsm <- lsmeans(m3React5, "ReappraisalDirection", by = c("group5"))
plot(lsm, horiz = F) +
  facet_grid(. ~ group5)
dev.off()
mEff <- allEffects(m3React5)
plot(mEff, axes = list(y = list(lab = "reactivity")))
stargazer(summary(m3React5)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group5 + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5*Reappraisal.htm")


# compare models , m1React4, m2React4, m3React4, m4React4
modellst <- model.sel(m1React5, m2React5, m3React5, m4React5)
print(modellst)
anova(m2React5, m3React5)
summary(m1React5)
summary(m2React5)
summary(m3React5)
summary(m4React5)

m1React4_1 <- lmer(
  scale(Rating, scale = FALSE) ~ ReappraisalDirection + group4 + (1|ID), data = reactivity)

m1React5_1 <- lmer(
  scale(Rating, scale = FALSE) ~ ReappraisalDirection + group5 + (1|ID), data = reactivity)
```
- Depression have higher reactivity compared to attempterHL.
- Depression under sympathy has higher reactivity compared to attempterHL under sympathy
- Depresssion under unfair has higher reactivity compared to attempterHL under unfair

# control other individual factors
```{r, MMSE}
mReact4MMSE1 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group4 + scale(MMSE) + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4*Reappraisal_MMSE.jpg')
lsm <- lsmeans(mReact4MMSE1, "ReappraisalDirection", by = c("group4"))
plot(lsm, horiz = F) +
  facet_grid(. ~ group4) +
  ggtitle("MMSE")
dev.off()
mEff <- allEffects(mReact4MMSE1)
plot(mEff, axes = list(y = list(lab = "reactivity")))
summary(mReact4MMSE1)
stargazer(summary(mReact4MMSE1)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group4 + MMSE + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4*Reappraisal_MMSE.htm")

mReact4MMSE2 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group4*scale(MMSE) + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group4*MMSE.jpg')
lsm <- lsmeans(mReact4MMSE2, "ReappraisalDirection", by = c("group4"))
plot(lsm, horiz = F, xlab = "reappraisal type") +
  facet_grid(. ~ group4) +
  ggtitle("MMSE")
dev.off()
mEff <- allEffects(mReact4MMSE2)
plot(mEff, axes = list(y = list(lab = "reactivity")))
summary(mReact4MMSE2)
stargazer(summary(mReact4MMSE2)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group4*MMSE + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group4*MMSE.htm")

anova(mReact4MMSE1, mReact4MMSE2)

mReact5MMSE1 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group5 + scale(MMSE) + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5*Reappraisal_MMSE.jpg')
lsm <- lsmeans(mReact5MMSE1, "ReappraisalDirection", by = c("group5"))
plot(lsm, horiz = F) +
  facet_grid(. ~ group5) +
  ggtitle("MMSE")
dev.off()
mEff <- allEffects(mReact5MMSE1)
plot(mEff, axes = list(y = list(lab = "reactivity")))
summary(mReact5MMSE1)
stargazer(summary(mReact5MMSE1)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group5 + MMSE + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5*Reappraisal_MMSE.htm")

mReact5MMSE2 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group5*scale(MMSE) + (1|ID), data = emoRating)
jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group5*MMSE.jpg')
lsm <- lsmeans(mReact5MMSE2, "ReappraisalDirection", by = c("group5"))
plot(lsm, horiz = F, xlab = "reappraisal type") +
  facet_grid(. ~ group5) +
  ggtitle("MMSE")
dev.off()
mEff <- allEffects(mReact5MMSE2)
plot(mEff, axes = list(y = list(lab = "reactivity")))
summary(mReact5MMSE2)
stargazer(summary(mReact5MMSE2)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group5*MMSE + (1|ID)",
          out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group5*MMSE.htm")

anova(mReact5MMSE2, mReact5MMSE1)

# group*MMSE*direction is better than two way interaction
```

```{r, individual factors}
VarLoop <- emoRating[, c("MMSE", "PROTECT2AGE", "GENDERTEXT", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION", "RACETEXT", "DRS", "EXIT", "BIS_NONPLAN", "urgency", "IIP15INTAMBV", "IIP15INTSEN", "IIP15AGRESS", "IRI_EMPATHETIC_CONCERN")]

# scaled emoRating df
#tmp <- sapply(emoRating, is.numeric)
#emoRatingScale <- emoRating
#emoRatingScale[tmp] <- lapply(emoRating[tmp], scale)

scaleVar <- scale(VarLoop[, c("MMSE", "PROTECT2AGE", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION")])

emoRatingScale <- emoRating
emoRatingScale[, c("MMSE", "PROTECT2AGE", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION")] <- scaleVar


# group4
## loop through all vars by "rating = ReappraisalDirection*group4*i + (1|ID)"
### output models

mReact4_3way <- lapply(varlist_complete, function(individualFactor){
  models <- lmer(substitute(Rating ~ ReappraisalDirection*group4*i + (1|ID),
                            list(i = as.name(individualFactor))),
                 data = emoRatingScale)
  print(models)
  return(stargazer(models, type = "text", title = paste("Rating ~ ReappraisalDirection*group4*", individualFactor, "+ (1|ID)"), out =
                     paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity/ReappraisalDirection*group4*", individualFactor, ".txt")))
})


### output models graphs
pltFun_React4_3way <- lapply(varlist_complete, function(individualFactor) {
  models <- lmer(substitute(Rating ~ ReappraisalDirection*group4*i + (1|ID),
                            list(i = as.name(individualFactor))), data = emoRatingScale)
  
  print(individualFactor)
  vars <- (emoRatingScale[, individualFactor])
  
  print(class(vars))
  lvls <- ifelse(class(vars) == "numeric", list(seq(min(vars), max(vars), length.out = 3)), list(unique(vars)))
  print(lvls)
  print(class(lvls))
  lvlsr <- lapply(lvls, round, 2)
  print(lvlsr)
  lvlsrn <- as.numeric(unlist(lvlsr))
  print(class(lvlsrn))
  pdf(paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/reactivity/ReappraisalDirection*group4*", individualFactor, ".pdf"))
  lsm <- lsmeans(models, "ReappraisalDirection", by = c(individualFactor, "group4"), at =list(as.formula(paste(individualFactor = lvlsrn, "group4"= c("attempter", "depression", "control", "ideator")))))
  
  print(lsm)
  plt <- plot(lsm, horiz = F, xlab = "reappraisal type") +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    ggtitle(paste("Rating ~ ReappraisalDirection*group4*", individualFactor, "+ (1|ID)")) +
    facet_grid(as.formula(paste(". ~", paste(individualFactor, "+ group4"))))
  dev.off()
  print(plt)
  return(plt) 

})


```

```{r, group5}
# ---------------------------------------------------group5-------------------------------------------

# group5
## models loop through all vars by "rating = _type*group5 + i + (1|ID)"
VarLoop1 <- emoRating[, c("MMSE", "PROTECT2AGE", "GENDERTEXT", "IncomePerCapita", "HRSD_NO_SUI", "EDUCATION", "RACETEXT", "DRS", "EXIT", "BIS_NONPLAN", "urgency", "IIP15INTAMBV", "IIP15INTSEN", "IIP15AGRESS", "IRI_EMPATHETIC_CONCERN")]
varlist1 <- names(VarLoop1)
mReact5list1 <- lapply(varlist1, function(x) {
  lmer(substitute(scale(Rating) ~ ReappraisalDirection*group5 + i + (1|ID), list(i = as.name(x))), data = emoRatingScale)
})
mReact5list1_summ <- lapply(mReact5list1, summary)

## loop through all vars by "rating = ReappraisalDirection*group5*i + (1|ID)"
VarLoop2 <- emoRating[, c("MMSE", "EDUCATION", "IncomePerCapita", "GENDERTEXT", "PROTECT2AGE", "HRSD_NO_SUI", "BIS_NONPLAN", "urgency", "IIP15INTAMBV", "IIP15INTSEN", "IIP15AGRESS", "IRI_EMPATHETIC_CONCERN")]
varlist2 <- names(VarLoop2)

mReact5list2 <- lapply(varlist2, function(x) {
  lmer(substitute(scale(Rating) ~ ReappraisalDirection*group5*i + (1|ID), list(i = as.name(x))), data = emoRatingScale)
})
mReact5list2_summ <- lapply(mReact5list2, summary)


for (i in mReact5list2_summ) {
  print(i$call)
  stargazer(i$coefficients, type = "text", title = paste("Rating ~ ReappraisalDirection*group5*", i, "+(1|ID)"),
            out = paste("/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/", i$call, ".htm"))
}


# group5 graphs
pltFun <- function(x){
  lsm <- lsmeans(x, "ReappraisalDirection", by = c("group5"))
  plt <- plot(lsm, horiz = F, xlab = "reappraisal type") +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    facet_grid(. ~ group5)
  return(plt)
}


pltFun1 <- function(x){
  mEff <- allEffects(x)
  plt1 <- plot(mEff, axes = list(y = list(lab = "reactivity"))) +
    facet_grid(. ~ group5)
  return(plt1)
}

## non interaction graphs
plt_NonInter1 <- lapply(mReact5list1, pltFun)
print(plt_NonInter1)
for (i in plt_NonInter1) {
  for (j in varlist) {
    #jpeg(paste('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group5+', j, '.jpg'))
    plt_NonInter <- i + ggtitle(paste("Rating=group5*ReappraisalDirection+", j))
    dev.off()
    print(plt_NonInter)
  }
}

plt2 <- lapply(mReact5list1, pltFun1)
print(plt2)

## interaction model graphs
plt_Inter1 <- lapply(mReact5list2, pltFun)
print(plt_Inter1)

for (i in plt_Inter1) {
  for (j in varlist) {
    plt_Inter <- i + ggtitle(paste("Rating=group5*ReappraisalDirection*", j))
    dev.off()
    print(plt_Inter)
  }
}

plt1 <- lapply(mReact5list2, pltFun1)
print(plt1)

print(plt_Inter1)
print(plt_NonInter1)
lapply(mReact5list1, summary)
lapply(mReact5list2, summary)
```

In no interaction models: 
- IIP15AGRESS Inventory of Interpersonal Problems - Aggression is significant
- depression x ReappraisalDirection: depression under sympathy and unfair has higher reactivity than attempterHL 

In interaction models:
- IIP15INTSEN Inventory of Interpersonal Problems - Interpersonal Sensitivity is significant
- attempterLL x sympathy/unfair; depression x sympathy/unfair have higher reactivity than attempterHL
- 3 way interaction

```{r, IIP15AGRESS}
# IIP15AGRESS is significant at Rating = ReappraisalDirection*group5+IIP15AGRESS

# group4 
mReact4Agress1 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group4+scale(IIP15AGRESS) + (1|ID), data = emoRating)

stargazer(summary(mReact4Agress1)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group5+IIP15AGRESS + (1|ID)", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group4_IIP15AGRESS.htm")

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group4*ReappraisalDirection+IIP15AGRESS.jpg')
lsm <- lsmeans(mReact4Agress1, "ReappraisalDirection", by = c("group4"))
plot(lsm, horiz = F, xlab = "reappraisal type") +
  facet_grid(. ~ group4) +
  ggtitle("IIP15AGRESS(no interaction with group and ReappraisalDirection)")
dev.off()
mEff <- allEffects(mReact4Agress1)
plot(mEff, axes = list(y = list(lab = "reactivity")))


# group5
mReact5Agress1 <- lmer(
  scale(Rating) ~ ReappraisalDirection*group5+scale(IIP15AGRESS) + (1|ID), data = emoRating)

stargazer(summary(mReact5Agress1)$coefficients, type = "html", title = "Rating ~ ReappraisalDirection*group5+IIP15AGRESS + (1|ID)", out = "/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=ReappraisalDirection*group5_IIP15AGRESS.htm")

jpeg('/Volumes/LAB/Suicide_UG/UG_data_analysis/outputs/rating=group5*Qtype+IIP15AGRESS.jpg')
lsm <- lsmeans(mReact5Agress1, "ReappraisalDirection", by = c("group5"))
plot(lsm, horiz = F, xlab = "reappraisal type") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  facet_grid(. ~ group5) +
  ggtitle("IIP15AGRESS(no interaction with group and ReappraisalDirection)")
dev.off()
mEff <- allEffects(mReact5Agress1)
plot(mEff, axes = list(y = list(lab = "reactivity")))



```